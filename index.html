<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Customer App</title>
    <style>
        /* बेसिक रीसेट और पेज की स्टाइलिंग */
        body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background-color: #e9ecef; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; }
        .app-container { width: 100%; max-width: 450px; background-color: #ffffff; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); display: flex; flex-direction: column; min-height: 100vh; position: relative; overflow: hidden; }
        .app-header { background-color: #a7f3d0; padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; color: #1f2937; }
        .app-name { font-size: 1.5em; font-weight: bold; }
        .balance { background-color: #ffffff; padding: 8px 15px; border-radius: 20px; font-size: 1.1em; font-weight: 600; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }
        .main-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .coupon-section { position: relative; margin-bottom: 20px; }
        .coupon-input { width: 100%; padding: 15px 50px 15px 20px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 30px; box-sizing: border-box; }
        .coupon-input::placeholder { color: #9ca3af; }
        .scanner-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; cursor: pointer; color: #ef4444; }
        .list-header { text-align: center; font-size: 1.2em; font-weight: 500; color: #4b5563; padding: 10px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; }
        .redeem-list { flex-grow: 1; overflow-y: auto; padding-top: 10px; }
        
        /* रिडीम लिस्ट आइटम */
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; background-color: #f9fafb; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .list-item-coupon { font-size: 0.9em; color: #374151; }
        .list-item-value { font-size: 1.1em; font-weight: 600; color: #16a34a; }
        
        /* === पॉप-अप स्कैनर के लिए CSS === */
        #scanner-modal {
            display: none; /* डिफ़ॉल्ट रूप से छिपा हुआ */
            position: fixed; /* पूरी स्क्रीन पर कब्ज़ा करें */
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.85); /* गहरा ओवरले */
            flex-direction: column; /* ऊपर-नीचे अलाइन करें */
            justify-content: center;
            align-items: center;
        }
        #scanner-modal.active {
            display: flex; /* इसे दिखाने के लिए फ्लेक्स करें */
        }
        #reader {
            width: 90%;
            max-width: 400px; /* स्कैनर व्यू का आकार */
            background: black;
            border-radius: 10px;
            border: 3px solid white;
            overflow: hidden; /* गोलाकार कोनों को लागू करने के लिए */
        }
        #close-scanner {
            position: absolute;
            top: 20px;
            right: 20px;
            color: #1f2937;
            background: white;
            border: none;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 1.5em;
            font-weight: bold;
            cursor: pointer;
            line-height: 40px; /* X को सेंटर करने के लिए */
            text-align: center;
        }

        /* अलर्ट संदेश */
        #alert-box { position: absolute; top: 0; left: 0; width: 100%; z-index: 1001;}
        .app-alert { padding: 15px; color: white; text-align: center; font-weight: 500; }
        .app-alert.success { background-color: #22c55e; }
        .app-alert.error { background-color: #ef4444; }
    </style>
</head>
<body>

    <div class="app-container">
        <!-- हेडर और मुख्य कंटेंट अपरिवर्तित... -->
        <header class="app-header"><div class="app-name">Reward App</div><div class="balance" id="balance-display">₹ 0</div></header>
        <main class="main-content">
            <div id="alert-box"></div>
            <div class="coupon-section">
                <input class="coupon-input" id="coupon-input" type="text" placeholder="कूपन कोड डालें या स्कैन करें">
                <div class="scanner-icon" id="scanner-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM3.75 9V7.5h-1.5V9h1.5zM3.75 13.5v-1.5h-1.5v1.5h1.5zM3.75 18v-1.5h-1.5V18h1.5zM8.25 4.5h-1.5v1.5h1.5V4.5zM8.25 9V7.5h-1.5V9h1.5zM8.25 13.5v-1.5h-1.5v1.5h1.5zM8.25 18v-1.5h-1.5V18h1.5zM12.75 4.5h-1.5v1.5h1.5V4.5zM12.75 9V7.5h-1.5V9h1.5zM12.75 13.5v-1.5h-1.5v1.5h1.5zM12.75 18v-1.5h-1.5V18h1.5zM17.25 4.5h-1.5v1.5h1.5V4.5zM17.25 9V7.5h-1.5V9h1.5zM17.25 13.5v-1.5h-1.5v1.5h1.5zM17.25 18v-1.5h-1.5V18h1.5zM21.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM21.75 9V7.5h-1.5V9h1.5zM21.75 13.5v-1.5h-1.5v1.5h1.5zM21.75 18v-1.5h-1.5V18h1.5z" /></svg>
                </div>
            </div>
            <div class="list-header">रिडीम लिस्ट</div>
            <div class="redeem-list" id="redeem-list"></div>
        </main>
    </div>

    <!-- QR स्कैनर पॉप-अप -->
    <div id="scanner-modal">
        <button id="close-scanner">×</button>
        <div id="reader"></div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <script>
    // --- कॉन्फ़िगरेशन और Firebase सेटअप (अपरिवर्तित) ---
    const firebaseConfig = { /* ... आपका कॉन्फ़िग ... */ };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // --- UI एलिमेंट्स और वेरिएबल्स ---
    const scannerButton = document.getElementById('scanner-button');
    const scannerModal = document.getElementById('scanner-modal');
    const closeScannerButton = document.getElementById('close-scanner');
    // ... अन्य UI एलिमेंट्स
    let html5QrCode = null;
    let currentUserId = null;

    // --- अन्य सभी फ़ंक्शंस (handleUser, loadUserData, redeemCoupon आदि) अपरिवर्तित ---

    // === संशोधित स्कैनर फ़ंक्शंस ===

    // 1. कैमरा और पॉप-अप बंद करने के लिए विश्वसनीय फ़ंक्शन
    function stopScanner() {
        if (html5QrCode && html5QrCode.isScanning) {
            html5QrCode.stop().then(() => {
                console.log("स्कैनर बंद कर दिया गया है।");
            }).catch(err => {
                console.error("स्कैनर को रोकने में त्रुटि:", err);
            });
        }
        scannerModal.classList.remove('active'); // पॉप-अप छिपाएं
    }
    
    // 2. कैमरा चालू करने और स्कैन सफल होने पर का फ़ंक्शन
    function startScanner() {
        // पहले पॉप-अप दिखाएं
        scannerModal.classList.add('active');

        // स्कैनर को इनिशियलाइज़ करें
        if (!html5QrCode) {
             html5QrCode = new Html5Qrcode("reader");
        }

        const onScanSuccess = async (decodedText, decodedResult) => {
            // तुरंत स्कैनर बंद करें
            stopScanner();
            showAlert("QR मिला, जाँच हो रही है...", true);
            
            // अब कूपन को रिडीम करें (लॉजिक अपरिवर्तित)
            let codeToRedeem = decodedText;
            try {
                const url = new URL(decodedText);
                const qrId = url.searchParams.get('qr');
                const qrCardSnap = await database.ref(`qrCards/${qrId}`).once('value');
                if (qrCardSnap.exists() && qrCardSnap.val().coupon) {
                    codeToRedeem = qrCardSnap.val().coupon;
                } else { throw new Error("अमान्य QR या कोई कूपन लिंक नहीं है"); }
            } catch (e) {
               codeToRedeem = decodedText;
            }
            await redeemCoupon(codeToRedeem);
        };
        
        const onScanFailure = (error) => {
           // console.warn(`QR कोड नहीं मिला: ${error}`);
        };

        const config = { fps: 10, qrbox: { width: 250, height: 250 } };
        html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
            .catch(err => {
                showAlert("कैमरा चालू नहीं हो सका। कृपया अनुमति दें।", false);
                console.error("कैमरा शुरू नहीं हो सका", err);
                stopScanner(); // अगर कोई त्रुटि हो तो पॉप-अप बंद करें
            });
    }

    // === ऐप की शुरुआत ===
    window.onload = function() {
        handleUser(); // उपयोगकर्ता की पहचान करें
        
        // स्कैनर शुरू करने और बंद करने के लिए इवेंट श्रोता
        scannerButton.addEventListener('click', startScanner);
        closeScannerButton.addEventListener('click', stopScanner);
        
        // ... बाकी का onload कोड ...
    };


    // ===== यहाँ शेष सभी जावास्क्रिप्ट फ़ंक्शंस पेस्ट करें =====
    // (जैसे handleUser, loadUserData, redeemCoupon, showAlert, आदि)
    // मैंने उन्हें यहाँ संक्षिप्तता के लिए छोड़ दिया है क्योंकि उनमें कोई बदलाव नहीं है।
    const COUPON_VALUE = 10;
    const balanceDisplay = document.getElementById('balance-display');
    const redeemList = document.getElementById('redeem-list');
    const couponInput = document.getElementById('coupon-input');
    const alertBox = document.getElementById('alert-box');

    function handleUser() { let userId = localStorage.getItem('rewardAppUserId'); if (!userId) { userId = database.ref().child('users').push().key; localStorage.setItem('rewardAppUserId', userId); } currentUserId = userId; loadUserData(); }
    function loadUserData() { if (!currentUserId) return; const userRef = database.ref(`users/${currentUserId}`); userRef.child('balance').on('value', snapshot => { const balance = snapshot.val() || 0; balanceDisplay.textContent = `₹ ${balance}`; }); userRef.child('redeemedCoupons').on('value', snapshot => { redeemList.innerHTML = ''; if (!snapshot.exists()) { redeemList.innerHTML = '<p style="text-align:center; color: #6b7280;">कोई कूपन रिडीम नहीं हुआ है।</p>'; return; } snapshot.forEach(childSnapshot => { const coupon = childSnapshot.val(); const listItem = `<div class="list-item"><span class="list-item-coupon">${childSnapshot.key}</span><span class="list-item-value">+ ₹${coupon.value}</span></div>`; redeemList.insertAdjacentHTML('afterbegin', listItem); }); }); }
    function showAlert(message, isSuccess = true) { alertBox.innerHTML = `<div class="app-alert ${isSuccess ? 'success' : 'error'}">${message}</div>`; setTimeout(() => { alertBox.innerHTML = ''; }, 4000); }
    async function redeemCoupon(rawCode) { if (!rawCode || rawCode.trim() === "") return; let couponId = rawCode.trim().toUpperCase(); const couponRef = database.ref(`coupons/${couponId}`); try { const snapshot = await couponRef.once('value'); if (!snapshot.exists()) { showAlert("यह कूपन कोड अमान्य है।", false); return; } const coupon = snapshot.val(); couponRef.transaction(currentCoupon => { if (!currentCoupon) return; if (currentCoupon.used) { showAlert(`कूपन ${couponId} पहले ही इस्तेमाल हो चुका है।`, false); return; } const twentyFourHours = 24 * 60 * 60 * 1000; const isActivated = currentCoupon.activationTime && (Date.now() - currentCoupon.activationTime > twentyFourHours); if (currentCoupon.status !== 'active' && !isActivated) { showAlert(`कूपन ${couponId} अभी सक्रिय नहीं है।`, false); return; } currentCoupon.used = true; currentCoupon.status = 'used'; currentCoupon.redeemedBy = currentUserId; currentCoupon.redeemedAt = firebase.database.ServerValue.TIMESTAMP; return currentCoupon; }, (error, committed) => { if (committed) { const userRef = database.ref(`users/${currentUserId}`); userRef.child('balance').transaction(currentBalance => (currentBalance || 0) + COUPON_VALUE); userRef.child(`redeemedCoupons/${couponId}`).set({ redeemedAt: firebase.database.ServerValue.TIMESTAMP, value: COUPON_VALUE }); showAlert(`बधाई! कूपन ${couponId} सफलतापूर्वक रिडीम हो गया।`); couponInput.value = ''; } else if(error){ showAlert("लेन-देन विफल रहा: " + error.message, false); } }); } catch (error) { showAlert("रिडीम करने में त्रुटि: " + error.message, false); } }
    
    // मैन्युअल इनपुट का सेटअप onload में करना सुनिश्चित करें
     window.onload = function() {
        handleUser(); // उपयोगकर्ता की पहचान करें
        
        scannerButton.addEventListener('click', startScanner);
        closeScannerButton.addEventListener('click', stopScanner);
        
        couponInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                redeemCoupon(couponInput.value);
            }
        });
    };
    </script>
</body>
</html>