<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenGallery (No Storage)</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body.dark { background-color: #1a202c; color: white; }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

<!-- Header -->
<header class="p-4 bg-white dark:bg-gray-800 flex justify-between items-center shadow">
  <h1 class="text-2xl font-bold">OpenGallery</h1>
  <div class="flex gap-2 items-center">
    <input type="text" id="search" placeholder="Search..." class="border px-2 py-1 rounded">
    <button id="toggleTheme" class="px-3 py-1 bg-gray-300 dark:bg-gray-600 rounded">ðŸŒ“</button>
    <label class="px-3 py-1 bg-blue-500 text-white rounded cursor-pointer">
      Upload
      <input type="file" id="fileInput" class="hidden" multiple accept="image/*,video/*">
    </label>
  </div>
</header>

<!-- Gallery -->
<main id="gallery" class="p-4 grid grid-cols-2 md:grid-cols-4 gap-4"></main>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
    authDomain: "grsc-chet.firebaseapp.com",
    databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
    projectId: "grsc-chet",
    messagingSenderId: "1029401721470",
    appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const fileInput = document.getElementById('fileInput');
  const gallery = document.getElementById('gallery');
  const searchInput = document.getElementById('search');
  let allItems = [];

  // File to Base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
      reader.readAsDataURL(file);
    });
  }

  // Upload Files
  fileInput.addEventListener('change', async (e) => {
    const files = e.target.files;
    for (let file of files) {
      const base64Data = await fileToBase64(file);
      const fileData = {
        name: file.name,
        data: base64Data,
        type: file.type.startsWith("video") ? "video" : "image",
        timestamp: Date.now()
      };
      await db.ref('gallery').push(fileData);
    }
    alert("Upload complete!");
    loadGallery();
  });

  // Load Gallery
  async function loadGallery() {
    gallery.innerHTML = '';
    allItems = [];
    const snapshot = await db.ref('gallery').orderByChild('timestamp').once('value');
    snapshot.forEach(child => {
      allItems.unshift({ key: child.key, ...child.val() });
    });
    displayGallery(allItems);
  }

  // Display Items
  function displayGallery(items) {
    gallery.innerHTML = '';
    items.forEach(item => {
      const media = item.type === "video"
        ? `<video src="${item.data}" controls class="w-full rounded"></video>`
        : `<img src="${item.data}" class="w-full rounded cursor-pointer">`;
      gallery.innerHTML += `
        <div class="bg-white dark:bg-gray-700 p-2 rounded shadow">
          ${media}
          <div class="flex gap-2 mt-2">
            <button onclick="copyLink('${item.data}')" class="flex-1 bg-gray-200 dark:bg-gray-600 p-1 rounded text-sm">Copy</button>
            <button onclick="showQR('${item.data}')" class="flex-1 bg-gray-200 dark:bg-gray-600 p-1 rounded text-sm">QR</button>
            <button onclick="deleteItem('${item.key}')" class="flex-1 bg-red-500 text-white p-1 rounded text-sm">ðŸ—‘</button>
          </div>
        </div>
      `;
    });
  }

  // Search Filter
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase();
    const filtered = allItems.filter(i => i.name.toLowerCase().includes(q));
    displayGallery(filtered);
  });

  // Copy Link
  function copyLink(url) {
    navigator.clipboard.writeText(url);
    alert("Link copied!");
  }

  // QR Code
  function showQR(url) {
    const qrWindow = window.open("", "QR Code", "width=300,height=300");
    QRCode.toCanvas(url, { width: 250 }, (err, canvas) => {
      if (!err) qrWindow.document.body.appendChild(canvas);
    });
  }

  // Delete with passcode
  function deleteItem(key) {
    const pass = prompt("Enter admin passcode:");
    if (pass === "1234") { // change passcode
      db.ref('gallery/' + key).remove();
      alert("Deleted!");
      loadGallery();
    } else {
      alert("Wrong passcode!");
    }
  }

  // Theme Toggle
  document.getElementById('toggleTheme').addEventListener('click', () => {
    document.body.classList.toggle('dark');
  });

  // Initial Load
  loadGallery();
</script>
</body>
</html>