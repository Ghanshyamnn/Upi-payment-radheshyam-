<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>üì∑ Photo Gallery (Admin + User)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f9f9f9;}
    header{background:#2196f3;color:#fff;padding:12px;text-align:center;font-size:20px;}
    #gallery{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));
             gap:12px;padding:15px;}
    .card{background:#fff;padding:10px;border-radius:8px;
          box-shadow:0 2px 6px rgba(0,0,0,0.15);text-align:center;}
    img{max-width:100%;border-radius:6px;}
    button{margin-top:6px;padding:6px 10px;background:#2196f3;
           color:#fff;border:none;border-radius:6px;cursor:pointer;}
    button.delete{background:#f44336;}
    button:disabled{background:#aaa;}
    .online{margin:10px;text-align:center;color:#444;}
    .admin-box{padding:15px;background:#fff;margin:12px;
               border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,0.15);}
    .progress{margin-top:10px;color:#333;}
    .preview img{max-width:200px;margin-top:10px;border-radius:8px;}
  </style>
</head>
<body>
  <header>üì∑ Photo Gallery + Admin Panel</header>

  <!-- üîπ Admin Options -->
  <div class="admin-box">
    <h3>üõ†Ô∏è Admin Options</h3>
    <input type="file" id="fileInput" accept="image/*"/>
    <div><button onclick="uploadPhoto()">Upload Photo</button></div>
    <div id="progress" class="progress"></div>
    <div class="preview"><img id="previewImg"/></div>
  </div>

  <!-- üîπ User Photo Gallery -->
  <div id="gallery"></div>
  <div id="online" class="online"></div>

  <script>
    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyD14Z3b7uCk62FBCK9SSZlczSxnMXndM1o",
      authDomain: "mp3-8247a.firebaseapp.com",
      databaseURL: "https://mp3-8247a-default-rtdb.firebaseio.com",
      projectId: "mp3-8247a",
      storageBucket: "mp3-8247a.firebasestorage.app",
      messagingSenderId: "228735051694",
      appId: "1:228735051694:web:99bdbbe737b66224ef4a3f"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    const gallery=document.getElementById("gallery");
    const online=document.getElementById("online");
    const fileInput=document.getElementById("fileInput");
    const progress=document.getElementById("progress");
    const previewImg=document.getElementById("previewImg");

    // üîπ Unique userId
    let userId=localStorage.getItem("userId");
    if(!userId){
      userId="user_"+Math.random().toString(36).substr(2,9);
      localStorage.setItem("userId",userId);
    }

    // üîπ Online presence
    const userRef=db.ref("onlineUsers/"+userId);
    userRef.set(true); userRef.onDisconnect().remove();
    db.ref("onlineUsers").on("value",snap=>{
      online.textContent="üë• Online Users: "+(snap.numChildren()||0);
    });

    // üîπ Load all photos realtime
    db.ref("photos").on("value",async snap=>{
      const data=snap.val()||{};
      gallery.innerHTML="";
      for(let key in data){
        const val=data[key];
        const chunks=val.chunks||{};
        const ordered=Object.keys(chunks).sort((a,b)=>+a-+b).map(k=>chunks[k]);
        const base64=ordered.join("");
        const url=`data:${val.mime||"image/jpeg"};base64,${base64}`;
        const card=document.createElement("div");
        card.className="card";
        card.innerHTML=`
          <img src="${url}" alt="${val.name}"/>
          <div>${val.name||"photo"}</div>
          <button onclick="downloadPhoto('${url}','${val.name||"photo.jpg"}')">‚¨á Download</button>
          <button class="delete" onclick="deletePhoto('${key}')">üóë Delete</button>
        `;
        gallery.appendChild(card);
      }
    });

    // üîπ Download function
    function downloadPhoto(url,name){
      const a=document.createElement("a");
      a.href=url; a.download=name;
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    // üîπ Delete photo (Admin only)
    function deletePhoto(key){
      if(confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ø‡§π ‡§´‡•ã‡§ü‡•ã ‡§π‡§ü‡§æ‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")){
        db.ref("photos/"+key).remove();
      }
    }

    // üîπ Upload photo
    function uploadPhoto(){
      const file=fileInput.files[0];
      if(!file){alert("‡§ï‡•É‡§™‡§Ø‡§æ ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç");return;}
      const reader=new FileReader();
      reader.onload=async function(e){
        const base64=e.target.result.split(",")[1]; 
        previewImg.src=e.target.result;

        const chunkSize=50000;
        let chunks={};
        for(let i=0;i<base64.length;i+=chunkSize){
          chunks[i/chunkSize]=base64.substr(i,chunkSize);
          progress.textContent=`Uploading... ${Math.min(base64.length,i+chunkSize)} / ${base64.length}`;
          await new Promise(r=>setTimeout(r,20));
        }

        const key=db.ref("photos").push().key;
        db.ref("photos/"+key).set({
          name:file.name,
          mime:file.type,
          chunks:chunks
        });
        progress.textContent="‚úÖ Upload Done!";
        fileInput.value="";
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
