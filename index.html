<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8">
  <title>📧 Gmail Login</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    body { font-family: sans-serif; background:#f5f5f5; text-align:center; padding:20px; }
    .card { background:#fff; padding:20px; border-radius:16px; max-width:420px; margin:40px auto; box-shadow:0 4px 12px rgba(0,0,0,0.15);}
    h2 { margin-bottom: 20px; }
    button { padding:12px 22px; border:none; border-radius:8px; background:#4285F4; color:#fff; font-size:16px; cursor:pointer; }
    button:hover { background:#3367d6; }
    img { border-radius:50%; margin:15px 0; }
    .code { font-size:20px; font-weight:bold; color:#222; margin-top:10px; }
    small { color:#666; }
  </style>
</head>
<body>

  <div class="card">
    <h2>📧 Gmail Login</h2>

    <div id="user-info" style="display:none;">
      <img id="user-pic" src="" width="90" height="90"><br>
      <strong id="user-name"></strong><br>
      <small id="user-email"></small>
      <div class="code">🔑 Code: <span id="user-code"></span></div>
      <br>
      <button onclick="logout()">Logout</button>
    </div>

    <div id="login-div">
      <button onclick="login()">Login with Google</button>
    </div>
  </div>

  <script>
    // 🔧 Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyD14Z3b7uCk62FBCK9SSZlczSxnMXndM1o",
      authDomain: "mp3-8247a.firebaseapp.com",
      databaseURL: "https://mp3-8247a-default-rtdb.firebaseio.com",
      projectId: "mp3-8247a",
      storageBucket: "mp3-8247a.firebasestorage.app",
      messagingSenderId: "228735051694",
      appId: "1:228735051694:android:99bdbbe737b66224ef4a3f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Random 6 character code generator
    function generateCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    // Login with Google
    function login() {
      const provider = new firebase.auth.GoogleAuthProvider();
      auth.signInWithPopup(provider)
        .then(result => {
          saveUser(result.user);
        })
        .catch(err => {
          alert("Login Error ❌: " + err.message);
        });
    }

    // Logout
    function logout() {
      auth.signOut();
    }

    // Save user in DB
    function saveUser(user) {
      const uid = user.uid;
      const ref = db.ref("users/" + uid);

      ref.once("value").then(snapshot => {
        if (!snapshot.exists() || !snapshot.val().code) {
          const code = generateCode();
          ref.set({
            name: user.displayName,
            email: user.email,
            photo: user.photoURL,
            code: code
          });
          db.ref("codes/" + code).set(uid);
        }
      });
    }

    // Auto login check
    auth.onAuthStateChanged(user => {
      if (user) {
        document.getElementById("login-div").style.display = "none";
        document.getElementById("user-info").style.display = "block";
        document.getElementById("user-pic").src = user.photoURL;
        document.getElementById("user-name").innerText = user.displayName;
        document.getElementById("user-email").innerText = user.email;

        db.ref("users/" + user.uid + "/code").once("value", snap => {
          document.getElementById("user-code").innerText = snap.val();
        });

      } else {
        document.getElementById("login-div").style.display = "block";
        document.getElementById("user-info").style.display = "none";
      }
    });
  </script>
</body>
</html>