<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>WhatsApp Style Firebase Chat (No Storage)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { font-family: Arial, sans-serif; margin: 0; background: #ece5dd; display: flex; flex-direction: column; height: 100vh; }
  #header { background: #075E54; color: white; padding: 12px; font-size: 18px; text-align: center; }
  #chat { flex: 1; overflow-y: auto; padding: 10px; }
  .msg { margin: 5px 0; padding: 8px; border-radius: 8px; max-width: 75%; word-wrap: break-word; font-size: 15px; }
  .me { background: #DCF8C6; margin-left: auto; }
  .other { background: white; margin-right: auto; }
  #inputArea { display: flex; padding: 8px; background: #f0f0f0; border-top: 1px solid #ddd; }
  #message { flex: 1; padding: 10px; border: 1px solid #ccc; border-radius: 20px; font-size: 15px; }
  button { padding: 10px; margin-left: 5px; border: none; border-radius: 50%; background: #25D366; color: white; font-size: 18px; width: 42px; height: 42px; }
  button:hover { background: #128C7E; cursor: pointer; }
  img.chat-img { max-width: 150px; border-radius: 6px; }
</style>
</head>
<body>

<div id="header">ðŸ’¬ My WhatsApp Chat</div>
<div id="chat"></div>

<div id="inputArea">
  <input type="text" id="message" placeholder="Type a message" onkeypress="if(event.key==='Enter'){sendMessage()}">
  <button onclick="sendMessage()">âž¤</button>
  <button onclick="chooseImage()">ðŸ“·</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database-compat.js"></script>

<script>
// âœ… Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
  authDomain: "grsc-chet.firebaseapp.com",
  databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
  projectId: "grsc-chet",
  storageBucket: "grsc-chet.appspot.com",
  messagingSenderId: "1029401721470",
  appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
};
firebase.initializeApp(firebaseConfig);

const db = firebase.database().ref("global_chat");
const userId = Math.random().toString(36).substr(2, 9);
const chatBox = document.getElementById("chat");

// âœ… Listen for new messages
db.on("child_added", snap => {
  const msg = snap.val();
  addMessage(msg, msg.userId === userId);
});

function addMessage(msg, isMe) {
  const div = document.createElement("div");
  div.classList.add("msg", isMe ? "me" : "other");

  if (msg.imageData) {
    div.innerHTML = `<img src="${msg.imageData}" class="chat-img">`;
  } else {
    div.textContent = msg.text;
  }

  chatBox.appendChild(div);
  chatBox.scrollTop = chatBox.scrollHeight;
}

// âœ… Send text message
function sendMessage() {
  const text = document.getElementById("message").value.trim();
  if (!text) return;
  db.push({ userId, text, timestamp: Date.now() });
  document.getElementById("message").value = "";
}

// âœ… Choose image
function chooseImage() {
  const input = document.createElement("input");
  input.type = "file";
  input.accept = "image/*";
  input.onchange = e => {
    const file = e.target.files[0];
    if (file) compressAndSendImage(file);
  };
  input.click();
}

// âœ… Compress & send image as Base64 to Firebase Realtime Database
function compressAndSendImage(file) {
  const reader = new FileReader();
  reader.onload = e => {
    const img = new Image();
    img.src = e.target.result;
    img.onload = () => {
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      // Set max size for compression
      const MAX_WIDTH = 800;
      let width = img.width;
      let height = img.height;

      if (width > MAX_WIDTH) {
        height *= MAX_WIDTH / width;
        width = MAX_WIDTH;
      }

      canvas.width = width;
      canvas.height = height;
      ctx.drawImage(img, 0, 0, width, height);

      // Compress to JPEG 70%
      const compressedData = canvas.toDataURL("image/jpeg", 0.7);

      // Save to Firebase Realtime Database
      db.push({ userId, imageData: compressedData, timestamp: Date.now() });
    };
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>