<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>MP3 Base64 ‡§Ö‡§™‡§≤‡•ã‡§° ‚Ä¢ Firebase RTDB</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase (Compat SDKs) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <style>
    :root{--primary:#007bff;--bg:#f7f7fb;}
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg)}
    header{
      position:sticky;top:0;z-index:10;background:var(--primary);color:#fff;
      display:flex;align-items:center;justify-content:space-between;padding:12px 16px
    }
    header .title{font-weight:700;font-size:18px}
    header .icon-btn{background:none;border:0;color:#fff;font-size:20px;cursor:pointer}
    main{max-width:680px;margin:0 auto;padding:16px}
    .card{
      background:#fff;border-radius:14px;box-shadow:0 4px 16px rgba(0,0,0,.06);
      padding:16px;margin:12px 0
    }
    .row{display:grid;gap:10px}
    @media(min-width:520px){.row{grid-template-columns:2fr 1fr}}
    input[type=file]{width:100%;padding:12px;border:1px solid #e6e6ef;border-radius:10px;background:#fff}
    .btn{padding:12px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600}
    .btn-primary{background:var(--primary);color:#fff;width:100%}
    .btn-danger{background:#e03131;color:#fff}
    .muted{color:#666;font-size:12px}
    .progress{height:8px;background:#e9ecef;border-radius:99px;overflow:hidden;margin-top:10px}
    .bar{height:100%;width:0%;background:var(--primary);transition:width .25s}
    .list{display:grid;gap:12px}
    .item{display:flex;gap:12px;align-items:center}
    .item .meta{flex:1}
    .item h4{margin:0 0 4px 0;font-size:15px}
    .chips{display:flex;gap:8px;flex-wrap:wrap}
    .chip{font-size:11px;background:#eef3ff;color:#2a52aa;padding:4px 8px;border-radius:20px}
    audio{width:100%}
    .actions{display:flex;gap:8px;margin-top:8px}
    .hide-on-mobile{display:none}
    @media(min-width:420px){.hide-on-mobile{display:inline-block}}
  </style>
</head>
<body>
  <header>
    <div class="title">üéµ MP3 Base64 ‡§Ö‡§™‡§≤‡•ã‡§°</div>
    <button class="icon-btn" title="‡§∞‡•Ä‡§´‡§º‡•ç‡§∞‡•á‡§∂" onclick="reloadList()">‚ü≥</button>
  </header>

  <main>
    <!-- ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§æ‡§∞‡•ç‡§° -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;">MP3 ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç</h3>
      <p class="muted">‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡§§‡•á ‡§π‡•Ä Base64 ‡§¨‡§®‡§ï‡§∞ Firebase Realtime Database ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§ú‡§æ‡§è‡§ó‡§æ‡•§ (‡§∏‡•Å‡§ù‡§æ‡§µ: 8MB ‡§∏‡•á ‡§õ‡•ã‡§ü‡•Ä ‡§´‡§º‡§æ‡§á‡§≤)</p>
      <div class="row">
        <input id="mp3Input" type="file" accept=".mp3,audio/mp3,audio/mpeg" />
        <button class="btn btn-primary" onclick="startUpload()">‡§Ö‡§™‡§≤‡•ã‡§°</button>
      </div>
      <div class="progress" aria-hidden="true"><div id="bar" class="bar"></div></div>
      <div id="status" class="muted" style="margin-top:8px;"></div>
    </div>

    <!-- ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§ï‡§æ‡§∞‡•ç‡§° -->
    <div class="card">
      <h3 style="margin:0 0 8px 0;">MP3 ‡§≤‡§ø‡§∏‡•ç‡§ü</h3>
      <div id="empty" class="muted">‡§Ö‡§≠‡•Ä ‡§ï‡•ã‡§à MP3 ‡§®‡§π‡•Ä‡§Ç ‡§π‡•à‡•§ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§Ø‡§π‡§æ‡§Å ‡§¶‡§ø‡§ñ‡§æ‡§à ‡§¶‡•á‡§ó‡§æ‡•§</div>
      <div id="list" class="list"></div>
    </div>
  </main>

  <script>
    // ‚öôÔ∏è Firebase Config (‡§Ü‡§™‡§ï‡•á mp3-8247a ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü ‡§∏‡•á)
    const firebaseConfig = {
      apiKey: "AIzaSyD14Z3b7uCk62FBCK9SSZlczSxnMXndM1o",
      authDomain: "mp3-8247a.firebaseapp.com",
      databaseURL: "https://mp3-8247a-default-rtdb.firebaseio.com",
      projectId: "mp3-8247a",
      storageBucket: "mp3-8247a.appspot.com",
      messagingSenderId: "228735051694",
      appId: "1:228735051694:web:99bdbbe737b66224ef4a3f"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    const input = document.getElementById('mp3Input');
    const bar = document.getElementById('bar');
    const statusEl = document.getElementById('status');
    const listEl = document.getElementById('list');
    const emptyEl = document.getElementById('empty');

    // üß† Util: nice bytes
    function formatBytes(bytes){
      if(bytes===0) return "0 B";
      const k=1024, sizes=["B","KB","MB","GB"], i=Math.floor(Math.log(bytes)/Math.log(k));
      return parseFloat((bytes/Math.pow(k,i)).toFixed(2))+" "+sizes[i];
    }

    // üéØ Upload Flow
    function startUpload(){
      const file = input.files && input.files[0];
      if(!file){ alert("‡§ï‡•É‡§™‡§Ø‡§æ MP3 ‡§´‡§º‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç"); return; }

      // ‡§µ‡•à‡§≤‡§ø‡§°‡•á‡§∂‡§®
      if(!/^audio\/(mp3|mpeg)$/.test(file.type) && !file.name.toLowerCase().endsWith('.mp3')){
        alert("‡§ï‡•á‡§µ‡§≤ MP3 ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞‡•ç‡§Ø ‡§π‡•à");
        return;
      }
      const maxBytes = 8 * 1024 * 1024; // 8 MB ‡§∏‡•Å‡§ù‡§æ‡§µ
      if(file.size > maxBytes){
        if(!confirm("‡§Ø‡§π ‡§´‡§º‡§æ‡§á‡§≤ "+formatBytes(file.size)+" ‡§ï‡•Ä ‡§π‡•à‡•§ ‡§¨‡§°‡§º‡•Ä Base64 RTDB ‡§Æ‡•á‡§Ç ‡§∏‡•ç‡§≤‡•ã ‡§π‡•ã ‡§∏‡§ï‡§§‡•Ä ‡§π‡•à‡•§ ‡§´‡§ø‡§∞ ‡§≠‡•Ä ‡§Ö‡§™‡§≤‡•ã‡§° ‡§ï‡§∞‡•á‡§Ç?")) return;
      }

      // ‡§™‡§¢‡§º‡§®‡§æ ‡§∂‡•Å‡§∞‡•Ç
      statusEl.textContent = "‡§´‡§º‡§æ‡§á‡§≤ ‡§™‡§¢‡§º‡•Ä ‡§ú‡§æ ‡§∞‡§π‡•Ä ‡§π‡•à‚Ä¶";
      bar.style.width = "15%";

      const reader = new FileReader();

      // Progress (‡§ï‡•Å‡§õ ‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§è‡§∏‡•ç‡§ü‡§ø‡§Æ‡•á‡§ü ‡§¶‡•á‡§§‡•á ‡§π‡•à‡§Ç)
      reader.onprogress = e => {
        if(e.lengthComputable){
          const p = Math.min(90, Math.floor((e.loaded / e.total) * 90));
          bar.style.width = p + "%";
        }
      };

      reader.onerror = () => {
        statusEl.textContent = "‡§∞‡•Ä‡§° ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à‡•§";
        bar.style.width = "0%";
      };

      reader.onload = async () => {
        try {
          // dataURL: "data:audio/mpeg;base64,AAA..."
          const dataURL = reader.result;
          const base64 = String(dataURL).split(',')[1]; // ‡§π‡•á‡§°‡§∞ ‡§π‡§ü‡§æ‡§è‡§Å
          statusEl.textContent = "Base64 ‡§§‡•à‡§Ø‡§æ‡§∞‡•§ ‡§°‡•á‡§ü‡§æ‡§¨‡•á‡§∏ ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ ‡§π‡•ã ‡§∞‡§π‡§æ ‡§π‡•à‚Ä¶";
          bar.style.width = "95%";

          // ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï: duration ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡§æ (‡§õ‡•ã‡§ü‡§æ ‡§∏‡§æ ‡§ü‡•ç‡§∞‡§ø‡§ï)
          const duration = await getAudioDuration(dataURL).catch(()=>null);

          // RTDB ‡§Æ‡•á‡§Ç ‡§∏‡•á‡§µ
          const item = {
            filename: file.name,
            type: file.type || "audio/mpeg",
            size: file.size,
            sizeText: formatBytes(file.size),
            createdAt: new Date().toISOString(),
            base64: base64,
            duration: duration
          };
          const ref = db.ref("mp3s").push();
          await ref.set(item);

          statusEl.textContent = "‚úÖ ‡§Ö‡§™‡§≤‡•ã‡§° ‡§∏‡§´‡§≤!";
          bar.style.width = "100%";
          input.value = "";

          // ‡§•‡•ã‡§°‡§º‡•Ä ‡§¶‡•á‡§∞ ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡•ã‡§ó‡•ç‡§∞‡•á‡§∏ ‡§∞‡•Ä‡§∏‡•á‡§ü
          setTimeout(()=>{ bar.style.width = "0%"; statusEl.textContent=""; }, 1200);
        } catch(err){
          console.error(err);
          statusEl.textContent = "‚ùå ‡§∏‡•á‡§µ ‡§ï‡§∞‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•Å‡§à";
          bar.style.width = "0%";
        }
      };

      reader.readAsDataURL(file);
    }

    // ‚è±Ô∏è ‡§ë‡§°‡§ø‡§Ø‡•ã duration ‡§®‡§ø‡§ï‡§æ‡§≤‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è
    function getAudioDuration(src){
      return new Promise((resolve,reject)=>{
        const audio = new Audio();
        audio.preload = "metadata";
        audio.src = src;
        audio.onloadedmetadata = () => resolve(Number.isFinite(audio.duration)? Math.round(audio.duration) : null);
        audio.onerror = reject;
      });
    }

    // üìú ‡§≤‡§ø‡§∏‡•ç‡§ü ‡§≤‡§æ‡§á‡§µ ‡§≤‡•ã‡§°
    function renderList(snap){
      listEl.innerHTML = "";
      const val = snap.val();
      if(!val){ emptyEl.style.display="block"; return; }

      emptyEl.style.display = "none";
      // ‡§®‡§µ‡•Ä‡§®‡§§‡§Æ ‡§™‡§π‡§≤‡•á ‡§¶‡§ø‡§ñ‡§æ‡§è‡§Å
      const entries = Object.entries(val).sort((a,b)=>{
        return (new Date(b[1].createdAt)) - (new Date(a[1].createdAt));
      });

      for(const [id, item] of entries){
        const dataURL = `data:${item.type || "audio/mpeg"};base64,${item.base64}`;

        const div = document.createElement('div');
        div.className = "item card";

        div.innerHTML = `
          <div class="meta">
            <h4>üéµ ${escapeHtml(item.filename || "Untitled.mp3")}</h4>
            <div class="chips">
              <span class="chip">${item.sizeText || formatBytes(item.size||0)}</span>
              ${item.duration ? `<span class="chip">‚è±Ô∏è ${item.duration}s</span>` : ""}
              <span class="chip">Base64</span>
            </div>
            <div class="actions">
              <button class="btn btn-danger hide-on-mobile" data-del="${id}">Delete</button>
              <button class="btn" style="background:#f1f3f5" data-copy="${id}">Copy Base64</button>
            </div>
          </div>
          <div style="width:100%;">
            <audio controls preload="none" src="${dataURL}"></audio>
          </div>
        `;

        // Delete
        div.querySelector('[data-del]')?.addEventListener('click', async () => {
          if(confirm("‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡•á‡§Ç?")) await db.ref("mp3s/"+id).remove();
        });

        // Copy Base64
        div.querySelector('[data-copy]')?.addEventListener('click', async () => {
          try {
            await navigator.clipboard.writeText(item.base64 || "");
            alert("Base64 ‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ!");
          } catch {
            prompt("‡§ï‡•â‡§™‡•Ä ‡§® ‡§π‡•ã ‡§™‡§æ‡§è ‡§§‡•ã ‡§Ø‡§π‡§æ‡§Å ‡§∏‡•á ‡§Æ‡•à‡§®‡•ç‡§Ø‡•Å‡§Ö‡§≤‡•Ä ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç:", item.base64 || "");
          }
        });

        listEl.appendChild(div);
      }
    }

    function escapeHtml(s){
      return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]));
    }

    // ‡§≤‡§ø‡§∏‡•ç‡§ü subscription
    const listRef = db.ref("mp3s");
    listRef.on("value", renderList);

    // ‡§Æ‡•à‡§®‡•Å‡§Ö‡§≤ ‡§∞‡•Ä‡§´‡§º‡•ç‡§∞‡•á‡§∂
    function reloadList(){ listRef.once("value").then(renderList); }
    window.reloadList = reloadList;
  </script>
</body>
</html>