<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenGallery Mobile</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<style>
  body.dark { background-color: #1a202c; color: white; }
  #lightbox {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.9);
    display: none; justify-content: center; align-items: center;
    z-index: 9999;
  }
  #lightbox img, #lightbox video {
    max-width: 95%; max-height: 95%;
    border-radius: 8px;
    touch-action: pinch-zoom;
  }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

<!-- Header -->
<header class="p-3 bg-white dark:bg-gray-800 flex flex-col md:flex-row md:justify-between md:items-center shadow gap-2">
  <div class="flex justify-between items-center w-full md:w-auto">
    <h1 class="text-xl font-bold">ðŸ“¸ OpenGallery</h1>
    <button id="toggleTheme" class="px-2 py-1 bg-gray-300 dark:bg-gray-600 rounded ml-2">ðŸŒ“</button>
  </div>
  <div class="flex gap-2 items-center w-full md:w-auto">
    <input type="text" id="search" placeholder="Search..." class="flex-1 border px-2 py-1 rounded text-sm">
    <label class="px-3 py-1 bg-blue-500 text-white rounded cursor-pointer text-sm">
      Upload
      <input type="file" id="fileInput" class="hidden" multiple accept="image/*,video/*">
    </label>
  </div>
</header>

<!-- Gallery -->
<main id="gallery" class="p-3 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-3"></main>

<!-- Lightbox -->
<div id="lightbox" onclick="closeLightbox()">
  <div id="lightboxContent"></div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>

<script>
  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
    authDomain: "grsc-chet.firebaseapp.com",
    databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
    projectId: "grsc-chet",
    messagingSenderId: "1029401721470",
    appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  const fileInput = document.getElementById('fileInput');
  const gallery = document.getElementById('gallery');
  const searchInput = document.getElementById('search');
  let allItems = [];
  let currentLightboxIndex = 0;

  // File to Base64
  function fileToBase64(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => resolve(reader.result);
      reader.onerror = (error) => reject(error);
      reader.readAsDataURL(file);
    });
  }

  // Upload Files
  fileInput.addEventListener('change', async (e) => {
    const files = e.target.files;
    for (let file of files) {
      const base64Data = await fileToBase64(file);
      const fileData = {
        name: file.name,
        data: base64Data,
        type: file.type.startsWith("video") ? "video" : "image",
        timestamp: Date.now()
      };
      await db.ref('gallery').push(fileData);
    }
    alert("Upload complete!");
    loadGallery();
  });

  // Load Gallery
  async function loadGallery() {
    gallery.innerHTML = '';
    allItems = [];
    const snapshot = await db.ref('gallery').orderByChild('timestamp').once('value');
    snapshot.forEach(child => {
      allItems.unshift({ key: child.key, ...child.val() });
    });
    displayGallery(allItems);
  }

  // Display Items
  function displayGallery(items) {
    gallery.innerHTML = '';
    items.forEach((item, index) => {
      const media = item.type === "video"
        ? `<video src="${item.data}" controls class="w-full rounded"></video>`
        : `<img src="${item.data}" class="w-full rounded cursor-pointer" onclick="openLightbox(${index})">`;
      gallery.innerHTML += `
        <div class="bg-white dark:bg-gray-700 p-2 rounded shadow">
          ${media}
          <div class="flex gap-1 mt-2 text-xs">
            <button onclick="copyLink('${item.data}')" class="flex-1 bg-gray-200 dark:bg-gray-600 p-1 rounded">Copy</button>
            <button onclick="showQR('${item.data}')" class="flex-1 bg-gray-200 dark:bg-gray-600 p-1 rounded">QR</button>
            <button onclick="downloadMedia('${item.data}','${item.name}')" class="flex-1 bg-green-500 text-white p-1 rounded">â¬‡</button>
            <button onclick="deleteItem('${item.key}')" class="flex-1 bg-red-500 text-white p-1 rounded">ðŸ—‘</button>
          </div>
        </div>
      `;
    });
  }

  // Search Filter
  searchInput.addEventListener('input', () => {
    const q = searchInput.value.toLowerCase();
    const filtered = allItems.filter(i => i.name.toLowerCase().includes(q));
    displayGallery(filtered);
  });

  // Copy Link
  function copyLink(url) {
    navigator.clipboard.writeText(url);
    alert("Link copied!");
  }

  // QR Code
  function showQR(url) {
    const qrWindow = window.open("", "QR Code", "width=300,height=300");
    QRCode.toCanvas(url, { width: 250 }, (err, canvas) => {
      if (!err) qrWindow.document.body.appendChild(canvas);
    });
  }

  // Download Media
  function downloadMedia(dataUrl, filename) {
    const a = document.createElement('a');
    a.href = dataUrl;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
  }

  // Delete with passcode
  function deleteItem(key) {
    const pass = prompt("Enter admin passcode:");
    if (pass === "1234") {
      db.ref('gallery/' + key).remove();
      alert("Deleted!");
      loadGallery();
    } else {
      alert("Wrong passcode!");
    }
  }

  // Light/Dark Mode
  document.getElementById('toggleTheme').addEventListener('click', () => {
    document.body.classList.toggle('dark');
  });

  // Lightbox
  function openLightbox(index) {
    currentLightboxIndex = index;
    const item = allItems[index];
    const content = item.type === "video"
      ? `<video src="${item.data}" controls autoplay></video>`
      : `<img src="${item.data}">`;
    document.getElementById('lightboxContent').innerHTML = content;
    document.getElementById('lightbox').style.display = 'flex';
  }
  function closeLightbox() {
    document.getElementById('lightbox').style.display = 'none';
  }

  // Swipe for Lightbox
  let touchStartX = 0;
  document.getElementById('lightbox').addEventListener('touchstart', e => {
    touchStartX = e.changedTouches[0].screenX;
  });
  document.getElementById('lightbox').addEventListener('touchend', e => {
    const diffX = e.changedTouches[0].screenX - touchStartX;
    if (diffX > 50) showPrev();
    if (diffX < -50) showNext();
  });

  function showPrev() {
    currentLightboxIndex = (currentLightboxIndex - 1 + allItems.length) % allItems.length;
    openLightbox(currentLightboxIndex);
  }
  function showNext() {
    currentLightboxIndex = (currentLightboxIndex + 1) % allItems.length;
    openLightbox(currentLightboxIndex);
  }

  // Init
  loadGallery();
</script>
</body>
</html>