<!doctype html>

<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>üî• Full App ‚Äî Gmail Login + Auto ID + Admin (Firebase)</title>
  <meta name="theme-color" content="#111827"/>
  <style>
    :root{--bg:#0f172a;--card:#111827;--muted:#9ca3af;--fg:#e5e7eb;--brand:#22c55e;--accent:#2563eb;--danger:#ef4444}
    *{box-sizing:border-box} html,body{height:100%} body{margin:0;font-family:"Noto Sans Devanagari",system-ui,sans-serif;background:linear-gradient(180deg,#0b1220,#0f172a 30%,#0b1220);color:var(--fg)}
    .container{max-width:980px;margin:0 auto;padding:16px}
    .appbar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;background:#0b1220aa;border:1px solid #1f2937;border-radius:16px;backdrop-filter:blur(6px);position:sticky;top:8px;z-index:10}
    .brand{display:flex;gap:10px;align-items:center;font-weight:700}
    .pill{font-size:12px;padding:4px 8px;border-radius:999px;background:#111827;border:1px solid #1f2937;color:var(--muted)}
    .grid{display:grid;gap:16px}
    @media(min-width:860px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:20px;padding:18px;box-shadow:0 8px 24px rgba(0,0,0,.25)}
    h1{font-size:22px;margin:0 0 6px} h2{font-size:18px;margin:0 0 8px}
    p{margin:6px 0 10px;color:var(--muted)}
    .row{display:grid;gap:10px}
    button{appearance:none;border:none;border-radius:12px;padding:12px 14px;font-weight:700}
    .btn{background:#111827;border:1px solid #1f2937;color:var(--fg);cursor:pointer}
    .btn:hover{filter:brightness(1.08)}
    .btn-primary{background:var(--accent);color:white}
    .btn-danger{background:var(--danger);color:white}
    .btn-ghost{background:transparent;border:1px dashed #334155}
    .flex{display:flex;align-items:center;gap:10px}
    .center{text-align:center}
    .avatar{width:64px;height:64px;border-radius:50%;object-fit:cover;border:2px solid #334155}
    .codebox{font-family:ui-monospace,Menlo,monospace;font-size:22px;letter-spacing:2px;text-align:center;padding:10px;border-radius:12px;background:#0b1220;border:1px solid #1f2937}
    .muted{color:var(--muted)}
    .kbd{font-family:ui-monospace,Menlo,monospace;background:#0b1220;border:1px solid #1f2937;border-radius:8px;padding:2px 6px}
    input[type="search"],input[type="text"],input[type="email"],input[type="password"]{width:100%;padding:12px;border-radius:12px;background:#0b1220;border:1px solid #1f2937;color:var(--fg)}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    th,td{text-align:left;padding:10px;border-bottom:1px dashed #233048}
    .badge{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #334155;color:var(--muted)}
    .hidden{display:none !important}
    /* ‡§≤‡•ã‡§°‡§ø‡§Ç‡§ó ‡§ì‡§µ‡§∞‡§≤‡•á */
    .loading{position:fixed;inset:0;display:none;place-items:center;background:rgba(2,6,23,.6);backdrop-filter:blur(2px);z-index:50}
    .spinner{width:40px;height:40px;border-radius:50%;border:4px solid #334155;border-top-color:#22c55e;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <div class="loading" id="loading"><div class="spinner"></div></div>
  <div class="container">
    <header class="appbar">
      <div class="brand">
        <span>‚ö°</span>
        <span>Full App</span>
        <span class="pill" id="envPill">Cloud</span>
      </div>
      <div class="flex">
        <button id="btnAdmin" class="btn btn-ghost hidden">Admin</button>
        <button id="btnLogout" class="btn btn-danger hidden">‡§≤‡•â‡§ó‡§Ü‡§â‡§ü</button>
      </div>
    </header><main class="grid" style="margin-top:16px">
  <!-- AUTH / PROFILE CARD -->
  <section class="card" id="authCard">
    <h1>üîê Gmail ‡§∏‡•á ‡§≤‡•â‡§ó‡§ø‡§®</h1>
    <p>‡§™‡§π‡§≤‡•Ä ‡§≤‡•â‡§ó‡§ø‡§® ‡§™‡§∞ 6-‡§ï‡•à‡§∞‡•á‡§ï‡•ç‡§ü‡§∞ ‡§Ø‡•Ç‡§®‡§ø‡§ï ‡§ï‡•ã‡§° ‡§ë‡§ü‡•ã-‡§ú‡§®‡§∞‡•á‡§ü ‡§π‡•ã‡§ï‡§∞ ‡§∏‡•á‡§µ ‡§π‡•ã‡§ó‡§æ‡•§ ‡§Ö‡§ó‡§≤‡•Ä ‡§¨‡§æ‡§∞ ‡§ë‡§ü‡•ã-‡§≤‡•â‡§ó‡§ø‡§®‡•§</p>
    <div id="authBox" class="row">
      <button id="googleBtn" class="btn btn-primary flex center" style="justify-content:center">
        <img alt="G" width="20" height="20" src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg"/>
        Continue with Google
      </button>
      <div id="authErr" class="pill hidden"></div>
    </div>

    <div id="profileBox" class="row hidden">
      <div class="flex">
        <img id="avatar" class="avatar" alt="avatar" src=""/>
        <div>
          <h2 id="userName">‡§Ø‡•Ç‡§ú‡§º‡§∞</h2>
          <div id="userEmail" class="muted"></div>
          <div id="userUid" class="badge"></div>
        </div>
      </div>
      <div>
        <div class="codebox" id="userCode">------</div>
        <p class="muted center">‡§Ø‡§π ‡§Ü‡§™‡§ï‡•Ä ‡§ë‡§ü‡•ã-‡§ú‡§®‡§∞‡•á‡§ü‡•á‡§° ‡§Ø‡•Ç‡§®‡§ø‡§ï ID ‡§π‡•à‡•§</p>
        <div class="flex" style="justify-content:center">
          <button id="copyCode" class="btn">‡§ï‡•ã‡§° ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç</button>
          <button id="regenCode" class="btn btn-ghost">‡§®‡§Ø‡§æ ‡§ï‡•ã‡§°</button>
        </div>
      </div>
    </div>
  </section>

  <!-- ADMIN PANEL CARD -->
  <section class="card hidden" id="adminCard">
    <h1>üõ°Ô∏è Admin Panel</h1>
    <p>‡§Ø‡•Ç‡§ú‡§º‡§∞ ‡§ï‡•ã‡§°‡•ç‡§∏ ‡§ï‡•Ä ‡§≤‡§ø‡§∏‡•ç‡§ü, ‡§∏‡§∞‡•ç‡§ö ‡§î‡§∞ ‡§è‡§ï‡•ç‡§∏‡§™‡•ã‡§∞‡•ç‡§ü‡•§</p>
    <div class="row">
      <input id="search" type="search" placeholder="Search: code, email, uid"/>
      <div class="flex">
        <button id="exportCsv" class="btn">Export CSV</button>
        <span class="badge" id="count">0 items</span>
      </div>
      <div style="overflow:auto">
        <table id="tbl"><thead>
          <tr><th>Code</th><th>Email</th><th>Name</th><th>UID</th></tr>
        </thead><tbody></tbody></table>
      </div>
    </div>
  </section>
</main>

  </div>  <!-- Firebase SDK (Compat v9) -->  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>  <script>
    // === CONFIG (‡§Ü‡§™‡§ï‡•á ‡§™‡•ç‡§∞‡•ã‡§ú‡•á‡§ï‡•ç‡§ü mp3-8247a ‡§ï‡§æ) ===
    const firebaseConfig = {
      apiKey: "AIzaSyD14Z3b7uCk62FBCK9SSZlczSxnMXndM1o",
      authDomain: "mp3-8247a.firebaseapp.com",
      databaseURL: "https://mp3-8247a-default-rtdb.firebaseio.com",
      projectId: "mp3-8247a",
      storageBucket: "mp3-8247a.firebasestorage.app",
      messagingSenderId: "228735051694",
      appId: "1:228735051694:android:99bdbbe737b66224ef4a3f"
    };

    // ‡§µ‡•à‡§ï‡§≤‡•ç‡§™‡§ø‡§ï: ‡§è‡§°‡§Æ‡§ø‡§® ‡§à‡§Æ‡•á‡§≤ allowlist (‡§Ö‡§™‡§®‡§æ ‡§à‡§Æ‡•á‡§≤ ‡§°‡§æ‡§≤‡•á‡§Ç)
    const ADMIN_EMAILS = [
      // "you@example.com"
    ];

    /* === Realtime Database Rules (Console ‚Üí Database ‚Üí Rules) ===
    {
      "rules": {
        ".read": false,
        ".write": false,
        "users": {
          "$uid": {
            ".read": "auth != null && auth.uid === $uid",
            ".write": "auth != null && auth.uid === $uid",
            "code": { ".validate": "newData.isString() && newData.val().matches(/^[A-Z0-9]{6}$/)" },
            "profile": {
              "email": { ".validate": "newData.isString()" },
              "displayName": { ".validate": "newData.isString() || newData.val() == null" },
              "photoURL": { ".validate": "newData.isString() || newData.val() == null" },
              "lastLoginAt": { ".validate": "newData.isNumber()" }
            }
          }
        },
        "codes": {
          "$code": {
            ".read": false,
            ".write": "auth != null && newData.val() === auth.uid && $code.matches(/^[A-Z0-9]{6}$/)"
          }
        },
        "admins": {
          "$uid": {
            ".read": "auth != null && auth.uid === $uid",
            ".write": "auth != null && root.child('admins').child(auth.uid).val() === true"
          }
        }
      }
    }
    */

    // === INIT APP ===
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // LOCAL persistence = auto-login on refresh
    auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL).catch(()=>{});

    // --- Smart ENV detect: localhost ‡§™‡§∞ ‡§π‡•ã‡§Ç ‡§§‡•ã Emulator use ‡§ï‡§∞‡§®‡•á ‡§ï‡•Ä ‡§ï‡•ã‡§∂‡§ø‡§∂ (optional) ---
    (function maybeUseEmulator(){
      const host = location.hostname;
      const onLocal = (host === 'localhost' || host === '127.0.0.1');
      if(onLocal){
        try {
          db.useEmulator('localhost', 9000);
          document.getElementById('envPill').textContent = 'Emulator';
        } catch(e){ /* ignore */ }
      }
    })();

    // === UI refs ===
    const btnLogout = document.getElementById('btnLogout');
    const btnAdmin  = document.getElementById('btnAdmin');

    const authCard  = document.getElementById('authCard');
    const adminCard = document.getElementById('adminCard');

    const authBox   = document.getElementById('authBox');
    const profileBox= document.getElementById('profileBox');
    const authErr   = document.getElementById('authErr');

    const userName  = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userUid   = document.getElementById('userUid');
    const avatar    = document.getElementById('avatar');
    const userCodeEl= document.getElementById('userCode');

    const googleBtn = document.getElementById('googleBtn');
    const copyCode  = document.getElementById('copyCode');
    const regenCode = document.getElementById('regenCode');

    const searchInp = document.getElementById('search');
    const tblBody   = document.querySelector('#tbl tbody');
    const countEl   = document.getElementById('count');
    const exportCsv = document.getElementById('exportCsv');

    function show(el){ el.classList.remove('hidden') }
    function hide(el){ el.classList.add('hidden') }
    function setErr(msg){
      if(!msg){hide(authErr); return;}
      authErr.textContent = humanizeError(msg);
      show(authErr);
    }
    function humanizeError(msg){
      if(!msg) return '';
      const m = String(msg);
      if(m.includes('auth/unauthorized-domain')) return '‡§Ø‡§π ‡§°‡•ã‡§Æ‡•á‡§® Authorized domains ‡§Æ‡•á‡§Ç ‡§ú‡•ã‡•ú‡•á‡§Ç (Firebase Console ‚Üí Auth ‚Üí Settings).';
      if(m.includes('auth/popup-blocked')) return '‡§¨‡•ç‡§∞‡§æ‡§â‡§ú‡§º‡§∞ ‡§®‡•á popup ‡§¨‡•ç‡§≤‡•â‡§ï ‡§ï‡§ø‡§Ø‡§æ‡•§ Allow ‡§ï‡§∞‡•á‡§Ç ‡§Ø‡§æ Redirect ‡§Æ‡•ã‡§° ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡•á‡§Ç‡•§';
      if(m.includes('auth/cancelled-popup-request')) return '‡§è‡§ï ‡§î‡§∞ ‡§≤‡•â‡§ó‡§ø‡§® ‡§µ‡§ø‡§Ç‡§°‡•ã ‡§ñ‡•Å‡§≤‡•Ä ‡§•‡•Ä ‚Äî ‡§¶‡•Å‡§¨‡§æ‡§∞‡§æ ‡§ü‡•ç‡§∞‡§æ‡§Ø ‡§ï‡§∞‡•á‡§Ç‡•§';
      if(m.includes('network-request-failed')) return '‡§®‡•á‡§ü‡§µ‡§∞‡•ç‡§ï ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‚Äî ‡§á‡§Ç‡§ü‡§∞‡§®‡•á‡§ü ‡§ö‡•á‡§ï ‡§ï‡§∞‡•á‡§Ç ‡§î‡§∞ ‡§´‡§ø‡§∞ ‡§ü‡•ç‡§∞‡§æ‡§Ø ‡§ï‡§∞‡•á‡§Ç‡•§';
      return m;
    }

    // === 6-char code ===
    function generate6Code(){
      const alphabet = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
      const bytes = new Uint8Array(6); crypto.getRandomValues(bytes);
      let out=''; for(let i=0;i<6;i++) out += alphabet[bytes[i]%alphabet.length];
      return out;
    }

    async function ensureUserCode(uid){
      const snap = await db.ref(`users/${uid}/code`).get();
      if(snap.exists()) return snap.val();
      for(let i=0;i<10;i++){
        const code = generate6Code();
        const res = await db.ref(`codes/${code}`).transaction(cur=>{ if(cur===null) return uid; });
        if(res.committed && res.snapshot.val()===uid){
          await db.ref(`users/${uid}/code`).set(code);
          return code;
        }
      }
      throw new Error('‡§ï‡•ã‡§° ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§¶‡§ø‡§ï‡•ç‡§ï‡§§ ‚Äî ‡§´‡§ø‡§∞ ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç');
    }

    async function saveProfile(user){
      const profile = {
        displayName: user.displayName || null,
        email: user.email || null,
        photoURL: user.photoURL || null,
        lastLoginAt: Date.now(),
      };
      await db.ref(`users/${user.uid}/profile`).update(profile);
    }

    async function maybeGrantAdmin(user){
      if(ADMIN_EMAILS.includes(user.email)){
        await db.ref(`admins/${user.uid}`).set(true);
      }
    }

    async function isAdmin(uid){
      const snap = await db.ref(`admins/${uid}`).get();
      return !!(snap.exists() && snap.val());
    }

    function fillProfileUI(user, code){
      userName.textContent = user.displayName || (user.email? user.email.split('@')[0] : '‡§Ø‡•Ç‡§ú‡§º‡§∞');
      userEmail.textContent= user.email || '';
      userUid.textContent  = user.uid;
      avatar.src = user.photoURL || '';
      avatar.style.display = user.photoURL? 'block':'none';
      userCodeEl.textContent = code || '------';
    }

    async function handleSignedIn(user){
      try{
        await saveProfile(user);
        await maybeGrantAdmin(user);
        const code = await ensureUserCode(user.uid);
        fillProfileUI(user, code);
        hide(authBox); show(profileBox); show(btnLogout);
        if(await isAdmin(user.uid)){ show(btnAdmin); } else { hide(btnAdmin); }
      }catch(e){
        setErr(e.message||String(e));
        show(authBox); hide(profileBox);
      }
    }

    function handleSignedOut(){
      hide(btnLogout); hide(btnAdmin);
      show(authBox); hide(profileBox);
      hide(adminCard);
    }

    // === Auth flow ===
    const provider = new firebase.auth.GoogleAuthProvider();
    provider.setCustomParameters({ prompt: 'select_account' });

    async function signIn(){
      setErr('');
      show(document.getElementById('loading'));
      const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
      try{
        if(isMobile) await auth.signInWithRedirect(provider);
        else await auth.signInWithPopup(provider);
      }catch(e){ setErr(e.message); }
      finally{ hide(document.getElementById('loading')); }
    }

    auth.getRedirectResult().catch(e=>setErr(e.message));
    auth.onAuthStateChanged(async user=>{
      if(user){ show(document.getElementById('loading')); await handleSignedIn(user); hide(document.getElementById('loading')); }
      else { handleSignedOut(); }
    });

    btnLogout.addEventListener('click', ()=> auth.signOut());
    googleBtn.addEventListener('click', signIn);

    copyCode.addEventListener('click', ()=>{
      const code = userCodeEl.textContent.trim();
      navigator.clipboard?.writeText(code);
      copyCode.textContent = '‡§ï‡•â‡§™‡•Ä ‡§π‡•ã ‡§ó‡§Ø‡§æ';
      setTimeout(()=> copyCode.textContent='‡§ï‡•ã‡§° ‡§ï‡•â‡§™‡•Ä ‡§ï‡§∞‡•á‡§Ç',1200);
    });

    regenCode.addEventListener('click', async ()=>{
      const user = auth.currentUser; if(!user) return;
      if(!confirm('‡§™‡•Å‡§∞‡§æ‡§®‡§æ ‡§ï‡•ã‡§° ‡§π‡§ü‡§ï‡§∞ ‡§®‡§Ø‡§æ ‡§¨‡§®‡•á‡§ó‡§æ. ‡§ú‡§æ‡§∞‡•Ä ‡§∞‡§ñ‡•á‡§Ç?')) return;
      try{
        const old = await db.ref(`users/${user.uid}/code`).get();
        if(old.exists()) await db.ref(`codes/${old.val()}`).remove();
        await db.ref(`users/${user.uid}/code`).remove();
        const fresh = await ensureUserCode(user.uid);
        userCodeEl.textContent = fresh;
      }catch(e){ alert(e.message); }
    });

    // === Admin panel ===
    btnAdmin.addEventListener('click', ()=>{
      adminCard.classList.toggle('hidden');
      if(!adminCard.classList.contains('hidden')) loadAdmin();
    });

    let rows = [];
    async function loadAdmin(){
      rows = [];
      tblBody.innerHTML = '<tr><td colspan="4" class="muted">Loading‚Ä¶</td></tr>';
      const codesSnap = await db.ref('codes').get();
      if(!codesSnap.exists()){ tblBody.innerHTML=''; countEl.textContent='0 items'; return; }
      const entries = Object.entries(codesSnap.val()); // [code, uid]
      for(const [code, uid] of entries){
        let email = '', name = '';
        try{
          const prof = await db.ref(`users/${uid}/profile`).get();
          if(prof.exists()){ email = prof.val().email||''; name = prof.val().displayName||''; }
        }catch{}
        rows.push({code, email, name, uid});
      }
      renderRows();
    }

    function renderRows(){
      const q = (searchInp.value||'').toLowerCase();
      const filtered = rows.filter(r=> (r.code||'').toLowerCase().includes(q) || (r.email||'').toLowerCase().includes(q) || (r.uid||'').toLowerCase().includes(q));
      tblBody.innerHTML = filtered.map(r=>`<tr>
        <td><span class="kbd">${r.code}</span></td>
        <td>${r.email||'<span class="muted">‚Äî</span>'}</td>
        <td>${r.name||'<span class="muted">‚Äî</span>'}</td>
        <td class="muted">${r.uid}</td>
      </tr>`).join('');
      countEl.textContent = `${filtered.length} items`;
    }

    searchInp.addEventListener('input', renderRows);

    exportCsv.addEventListener('click', ()=>{
      const header = ['code','email','name','uid'];
      const q = (searchInp.value||'').toLowerCase();
      const filtered = rows.filter(r=> (r.code||'').toLowerCase().includes(q) || (r.email||'').toLowerCase().includes(q) || (r.uid||'').toLowerCase().includes(q));
      const lines = [header.join(',')].concat(filtered.map(r=> [r.code,r.email,r.name,r.uid].map(s=>`"${(s||'').replaceAll('"','""')}"`).join(',')));
      const blob = new Blob(["\uFEFF"+lines.join('\n')], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download='users.csv'; a.click(); URL.revokeObjectURL(url);
    });
  </script></body>
</html>