<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>OpenGallery Final</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
  body.dark { background-color: #1a202c; color: white; }
  #lightbox {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.9);
    display: none; flex-direction: column; justify-content: center; align-items: center;
    z-index: 9999;
  }
  #lightbox img, #lightbox video { max-width: 95%; max-height: 85%; border-radius: 8px; }
  #downloadBtn { margin-top: 10px; background: rgba(255,255,255,0.2); padding: 8px 12px; border-radius: 6px; color: white; }
</style>
</head>
<body class="bg-gray-100 dark:bg-gray-900">

<!-- Header -->
<header class="p-4 bg-white dark:bg-gray-800 flex flex-col sm:flex-row sm:justify-between sm:items-center shadow gap-3">
  <div class="flex justify-between items-center w-full sm:w-auto">
    <h1 class="text-xl font-bold">ðŸ“¸ OpenGallery</h1>
    <button id="toggleTheme" class="px-2 py-1 bg-gray-300 dark:bg-gray-600 rounded ml-2">ðŸŒ“</button>
  </div>
  <div class="flex gap-2 items-center w-full sm:w-auto">
    <input type="text" id="search" placeholder="Search..." class="flex-1 border px-3 py-2 rounded text-sm">
    <label class="px-4 py-2 bg-blue-500 text-white rounded cursor-pointer text-sm hover:bg-blue-600">
      Upload
      <input type="file" id="fileInput" class="hidden" multiple accept="image/*,video/*">
    </label>
  </div>
</header>

<!-- Gallery -->
<main id="gallery" class="p-4 grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></main>

<!-- Lightbox -->
<div id="lightbox" onclick="closeLightbox()">
  <div id="lightboxContent"></div>
  <button id="downloadBtn" onclick="event.stopPropagation(); downloadCurrent()">â¬‡ Download</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-database-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.11/firebase-storage-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
  authDomain: "grsc-chet.firebaseapp.com",
  databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
  projectId: "grsc-chet",
  storageBucket: "grsc-chet.appspot.com",
  messagingSenderId: "1029401721470",
  appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();
const storage = firebase.storage();

let allItems = [];
let loadedKeys = new Set();
let currentLightboxIndex = 0;

// Local cache load
function loadFromCache() {
  const cached = localStorage.getItem("galleryCache");
  if (cached) {
    allItems = JSON.parse(cached);
    renderGallery();
  }
}

// Save to cache
function saveToCache() {
  localStorage.setItem("galleryCache", JSON.stringify(allItems));
}

// Thumbnail creator
function createThumbnail(base64Data, maxWidth = 200) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const canvas = document.createElement("canvas");
      let scale = maxWidth / img.width;
      if (img.width < maxWidth) scale = 1;
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;
      const ctx = canvas.getContext("2d");
      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
      resolve(canvas.toDataURL("image/jpeg", 0.7));
    };
    img.src = base64Data;
  });
}

// Upload
document.getElementById('fileInput').addEventListener('change', async (e) => {
  const files = [...e.target.files];
  for (const file of files) {
    if (file.type.startsWith("image")) {
      const reader = new FileReader();
      reader.onload = async () => {
        const fullImage = reader.result;
        const thumb = await createThumbnail(fullImage);
        db.ref('gallery').push({
          name: file.name,
          thumb: thumb,
          data: fullImage,
          type: "image",
          timestamp: Date.now()
        });
      };
      reader.readAsDataURL(file);
    } else if (file.type.startsWith("video")) {
      const ref = storage.ref('videos/' + Date.now() + '-' + file.name);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      db.ref('gallery').push({
        name: file.name,
        thumb: "",
        data: url,
        type: "video",
        timestamp: Date.now()
      });
    }
  }
});

// Real-time load
function loadGallery() {
  db.ref('gallery').orderByChild('timestamp').on('child_added', (snap) => {
    if (!loadedKeys.has(snap.key)) {
      loadedKeys.add(snap.key);
      allItems.unshift({ key: snap.key, ...snap.val() });
      saveToCache();
      renderGallery();
    }
  });
}

// Render
function renderGallery() {
  const searchTerm = document.getElementById('search').value.toLowerCase();
  const gallery = document.getElementById('gallery');
  gallery.innerHTML = '';
  allItems
    .filter(i => i.name.toLowerCase().includes(searchTerm))
    .forEach((item, index) => {
      const media = item.type === "video"
        ? `<video src="${item.data}" controls class="w-full rounded shadow cursor-pointer" onclick="openLightbox(${index})"></video>`
        : `<img src="${item.thumb || item.data}" class="w-full rounded shadow cursor-pointer" onclick="openLightbox(${index})">`;
      gallery.innerHTML += `<div class="bg-white dark:bg-gray-700 p-2 rounded shadow">${media}</div>`;
    });
}

// Lightbox
function openLightbox(index) {
  currentLightboxIndex = index;
  const item = allItems[index];
  const content = item.type === "video"
    ? `<video src="${item.data}" controls autoplay></video>`
    : `<img src="${item.data}">`;
  document.getElementById('lightboxContent').innerHTML = content;
  document.getElementById('lightbox').style.display = 'flex';
}
function closeLightbox() {
  document.getElementById('lightbox').style.display = 'none';
}
function downloadCurrent() {
  const item = allItems[currentLightboxIndex];
  const a = document.createElement('a');
  a.href = item.data;
  a.download = item.name;
  a.click();
}

// Search
document.getElementById('search').addEventListener('input', renderGallery);

// Theme
document.getElementById('toggleTheme').addEventListener('click', () => {
  document.body.classList.toggle('dark');
});

// Init
loadFromCache();
loadGallery();
</script>
</body>
</html>