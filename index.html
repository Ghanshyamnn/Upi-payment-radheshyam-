<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR कोड स्कैनर</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- jsQR library for QR code decoding -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        /* Custom styles for the video and scanner box */
        #video-container {
            position: relative;
            width: 100%;
            max-width: 500px;
            margin: 0 auto;
            overflow: hidden;
            border-radius: 0.75rem; /* rounded-xl */
        }
        #video {
            width: 100%;
            height: auto;
            display: block;
        }
        #scan-box {
            position: absolute;
            top: 50%;
            left: 50%;
            width: 70%;
            height: 50%;
            transform: translate(-50%, -50%);
            border: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 0.75rem;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            animation: scan-animation 2s infinite;
        }
        @keyframes scan-animation {
            0% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
            50% { box-shadow: 0 0 30px rgba(76, 175, 80, 1); }
            100% { box-shadow: 0 0 20px rgba(76, 175, 80, 0.5); }
        }
    </style>
</head>
<body class="bg-gray-100 dark:bg-gray-900 text-gray-900 dark:text-gray-100 flex flex-col items-center justify-center min-h-screen p-4 font-sans">

    <div class="w-full max-w-2xl mx-auto bg-white dark:bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-8 text-center">
        
        <h1 class="text-3xl md:text-4xl font-bold mb-2 text-gray-800 dark:text-white">QR कोड स्कैनर</h1>
        <p class="text-gray-600 dark:text-gray-300 mb-6">कैमरे को QR कोड पर रखें या स्कैन करने के लिए एक छवि अपलोड करें।</p>

        <!-- Video container for camera stream -->
        <div id="video-container" class="mb-4 bg-gray-200 dark:bg-gray-700 hidden">
            <video id="video" playsinline></video>
            <div id="scan-box"></div>
        </div>
        <canvas id="canvas" class="hidden"></canvas>

        <!-- Controls -->
        <div class="flex flex-col sm:flex-row gap-4 justify-center items-center mb-6">
            <button id="start-scan" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                स्कैन शुरू करें
            </button>
            <label for="file-input" class="w-full sm:w-auto cursor-pointer bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" /></svg>
                छवि अपलोड करें
                <input id="file-input" type="file" accept="image/*" class="hidden">
            </label>
            <button id="switch-camera" class="w-full sm:w-auto bg-purple-600 hover:bg-purple-700 text-white font-bold py-3 px-6 rounded-lg transition-transform transform hover:scale-105 shadow-lg hidden items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5M20 20v-5h-5M4 20L20 4" /></svg>
                 कैमरा बदलें
            </button>
        </div>
        
        <!-- Result Display -->
        <div id="result-container" class="w-full mt-4 p-5 bg-gray-100 dark:bg-gray-700 rounded-lg text-left hidden">
            <h2 class="text-xl font-bold mb-3 text-gray-800 dark:text-white">स्कैन का परिणाम:</h2>
            <div id="result" class="text-lg text-blue-500 break-all bg-white dark:bg-gray-600 p-4 rounded-md shadow-inner"></div>
            <button id="copy-result" class="mt-4 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg transition-colors">
                परिणाम कॉपी करें
            </button>
        </div>

        <!-- Scan History -->
        <div id="history-container" class="w-full mt-6 text-left">
            <h2 class="text-xl font-bold mb-3 text-gray-800 dark:text-white">स्कैन हिस्ट्री</h2>
            <ul id="history-list" class="list-disc list-inside bg-gray-100 dark:bg-gray-700 p-4 rounded-lg max-h-40 overflow-y-auto">
                <li id="no-history" class="text-gray-500 dark:text-gray-400">अभी तक कोई हिस्ट्री नहीं है।</li>
            </ul>
            <button id="clear-history" class="mt-4 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition-colors hidden">
                हिस्ट्री साफ़ करें
            </button>
        </div>

        <!-- Error Message -->
        <div id="error-message" class="w-full mt-4 p-4 bg-red-100 dark:bg-red-900 border border-red-400 dark:border-red-700 text-red-700 dark:text-red-200 rounded-lg hidden"></div>
    </div>
    <audio id="scan-sound" src="https://cdn.jsdelivr.net/gh/Simple-MAX/QR-Code-Generator-and-Scanner@master/assets/audio/beep.mp3" preload="auto"></audio>

    <script>
        // DOM elements
        const videoContainer = document.getElementById('video-container');
        const video = document.getElementById('video');
        const canvasElement = document.getElementById('canvas');
        const canvas = canvasElement.getContext('2d');
        const startScanBtn = document.getElementById('start-scan');
        const fileInput = document.getElementById('file-input');
        const resultContainer = document.getElementById('result-container');
        const resultElement = document.getElementById('result');
        const copyBtn = document.getElementById('copy-result');
        const errorMessageElement = document.getElementById('error-message');
        const switchCameraBtn = document.getElementById('switch-camera');
        const scanSound = document.getElementById('scan-sound');

        // History elements
        const historyList = document.getElementById('history-list');
        const noHistoryMsg = document.getElementById('no-history');
        const clearHistoryBtn = document.getElementById('clear-history');

        let stream;
        let animationFrameId;
        let currentFacingMode = 'environment';
        let scanHistory = JSON.parse(localStorage.getItem('scanHistory')) || [];

        function displayError(message) {
            errorMessageElement.textContent = `त्रुटि: ${message}`;
            errorMessageElement.classList.remove('hidden');
        }
        
        function updateHistory(data) {
            if (!scanHistory.includes(data)) {
                scanHistory.unshift(data);
                if (scanHistory.length > 20) scanHistory.pop();
                localStorage.setItem('scanHistory', JSON.stringify(scanHistory));
            }
            renderHistory();
        }

        function renderHistory() {
            historyList.innerHTML = '';
            if (scanHistory.length === 0) {
                historyList.appendChild(noHistoryMsg);
                clearHistoryBtn.classList.add('hidden');
            } else {
                scanHistory.forEach(item => {
                    const li = document.createElement('li');
                    li.className = "mb-2 text-sm text-gray-700 dark:text-gray-300 break-all";
                    try {
                        new URL(item);
                        li.innerHTML = `<a href="${item}" target="_blank" rel="noopener noreferrer" class="hover:underline text-blue-500">${item}</a>`;
                    } catch (_) {
                        li.textContent = item;
                    }
                    historyList.appendChild(li);
                });
                clearHistoryBtn.classList.remove('hidden');
            }
        }
        
        function displayResult(data) {
            stopScanner(false);
            scanSound.play();
            try {
                new URL(data);
                resultElement.innerHTML = `<a href="${data}" target="_blank" rel="noopener noreferrer" class="hover:underline">${data}</a>`;
            } catch (_) {
                resultElement.textContent = data;
            }
            resultContainer.classList.remove('hidden');
            updateHistory(data);
        }

        function stopScanner(fullStop = true) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }
            if (fullStop && stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
                videoContainer.classList.add('hidden');
                switchCameraBtn.classList.add('hidden');
                startScanBtn.innerHTML = startScanBtn.innerHTML.replace('स्कैन बंद करें', 'स्कैन शुरू करें');
            }
        }
        
        async function startCamera() {
            try {
                if (stream) stopScanner();
                
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: currentFacingMode } });
                video.srcObject = stream;
                video.style.transform = (currentFacingMode === 'user') ? 'scaleX(-1)' : 'scaleX(1)';
                await video.play();
                videoContainer.classList.remove('hidden');
                startScanBtn.innerHTML = startScanBtn.innerHTML.replace('स्कैन शुरू करें', 'स्कैन बंद करें');
                switchCameraBtn.classList.remove('hidden');
                animationFrameId = requestAnimationFrame(tick);
            } catch (err) {
                displayError("कैमरा एक्सेस नहीं हो सका। कृपया अनुमति दें।");
                stopScanner();
            }
        }

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvasElement.height = video.videoHeight;
                canvasElement.width = video.videoWidth;
                canvas.drawImage(video, 0, 0, canvasElement.width, canvasElement.height);
                const imageData = canvas.getImageData(0, 0, canvasElement.width, canvasElement.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height, { inversionAttempts: "dontInvert" });
                if (code) {
                    displayResult(code.data);
                    return;
                }
            }
            if (stream) animationFrameId = requestAnimationFrame(tick);
        }

        startScanBtn.addEventListener('click', () => {
            resultContainer.classList.add('hidden');
            errorMessageElement.classList.add('hidden');
            if (stream) stopScanner();
            else startCamera();
        });

        switchCameraBtn.addEventListener('click', () => {
            currentFacingMode = (currentFacingMode === 'environment') ? 'user' : 'environment';
            startCamera();
        });

        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;
            stopScanner();
            const reader = new FileReader();
            reader.onload = e => {
                const img = new Image();
                img.onload = () => {
                    canvasElement.width = img.width;
                    canvasElement.height = img.height;
                    canvas.drawImage(img, 0, 0, img.width, img.height);
                    const imageData = canvas.getImageData(0, 0, img.width, img.height);
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    if (code) {
                        displayResult(code.data);
                    } else {
                        displayError("इस छवि में कोई QR कोड नहीं मिला।");
                    }
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        });

        copyBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(resultElement.textContent).then(() => {
                copyBtn.textContent = 'कॉपी हो गया!';
                setTimeout(() => { copyBtn.textContent = 'परिणाम कॉपी करें'; }, 2000);
            }).catch(err => displayError('कॉपी करने में विफल।'));
        });
        
        clearHistoryBtn.addEventListener('click', () => {
            scanHistory = [];
            localStorage.removeItem('scanHistory');
            renderHistory();
        });

        renderHistory();
    </script>
</body>
</html>