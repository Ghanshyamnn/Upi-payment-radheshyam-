<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Firebase Chat App</title>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; background: #f5f5f5; }
    header { background: #4dd0e1; padding: 12px; text-align: center; font-size: 22px; font-weight: bold; }
    #container { display: flex; height: 90vh; }
    #users { width: 150px; border-right: 1px solid #ccc; background: #fff; padding: 10px; overflow-y: auto; }
    #chat { flex: 1; display: flex; flex-direction: column; }
    #messages { flex: 1; padding: 10px; overflow-y: auto; background: #fafafa; }
    .msg { max-width: 70%; margin: 5px; padding: 8px 12px; border-radius: 15px; word-wrap: break-word; }
    .me { background: #dcf8c6; align-self: flex-end; }
    .other { background: #fff; align-self: flex-start; border: 1px solid #eee; }
    .preview { max-width: 120px; margin-top: 5px; border-radius: 8px; }
    #controls { display: flex; padding: 8px; background: #eee; }
    #msg { flex: 1; border: none; padding: 10px; border-radius: 20px; margin-right: 5px; }
    #file { display: none; }
    button { border: none; background: #4dd0e1; color: #fff; padding: 10px 15px; border-radius: 50%; margin-left: 5px; cursor: pointer; }
    progress { width: 100%; margin-top: 5px; }
  </style>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, onValue, onDisconnect } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // üîπ Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
      authDomain: "grsc-chet.firebaseapp.com",
      databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
      projectId: "grsc-chet",
      storageBucket: "grsc-chet.appspot.com",
      messagingSenderId: "1029401721470",
      appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const ROOM_KEY = "publicRoom";

    // üîπ Elements
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("msg");
    const fileEl = document.getElementById("file");
    const usersEl = document.getElementById("users");

    // üîπ User Info
    const userId = "user_" + Math.floor(Math.random()*100000);
    const nick = localStorage.getItem("nick") || prompt("Enter your name") || "Guest";
    localStorage.setItem("nick", nick);

    // üîπ Save User Status
    const userRef = ref(db, `users/${userId}`);
    set(userRef, { name: nick, online: true, lastSeen: Date.now() });
    onDisconnect(userRef).update({ online: false, lastSeen: Date.now() });

    // üîπ Buttons
    document.getElementById("send").onclick = sendText;
    document.getElementById("sendFile").onclick = () => fileEl.click();
    fileEl.onchange = sendFile;

    // üîπ Send Text
    function sendText() {
      if (!inputEl.value.trim()) return;
      const msgRef = push(ref(db, `groups/${ROOM_KEY}/messages`));
      set(msgRef, {
        senderId: userId,
        senderName: nick,
        text: inputEl.value.trim(),
        timestamp: Date.now(),
        type: "text"
      });
      inputEl.value = "";
    }

    // üîπ Send File (with size check)
    function sendFile() {
      const file = fileEl.files[0];
      if (!file) return;

      if (file.size > 9 * 1024 * 1024) {
        alert("‚ö†Ô∏è ‡§Ø‡§π ‡§´‡§æ‡§á‡§≤ ‡§¨‡§π‡•Å‡§§ ‡§¨‡§°‡§º‡•Ä ‡§π‡•à (10MB limit in Firebase Realtime DB)‡•§ ‡§õ‡•ã‡§ü‡•Ä ‡§´‡§æ‡§á‡§≤ ‡§ö‡•Å‡§®‡•á‡§Ç‡•§");
        return;
      }

      const reader = new FileReader();
      reader.onloadstart = () => {
        const prog = document.createElement("progress");
        prog.id = "uploadProgress";
        prog.max = 100;
        prog.value = 0;
        messagesEl.appendChild(prog);
      };
      reader.onprogress = (e) => {
        if (e.lengthComputable) {
          const percent = Math.round((e.loaded / e.total) * 100);
          const prog = document.getElementById("uploadProgress");
          if (prog) prog.value = percent;
        }
      };
      reader.onload = function(e) {
        const base64 = e.target.result;
        const msgRef = push(ref(db, `groups/${ROOM_KEY}/messages`));
        set(msgRef, {
          senderId: userId,
          senderName: nick,
          fileData: base64,
          fileName: file.name,
          mimeType: file.type,
          timestamp: Date.now(),
          type: "file"
        }).then(() => {
          console.log("‚úÖ File uploaded:", file.name);
          const prog = document.getElementById("uploadProgress");
          if (prog) prog.remove();
        });
      };
      reader.readAsDataURL(file);
    }

    // üîπ Load Messages
    const messagesRef = ref(db, `groups/${ROOM_KEY}/messages`);
    onChildAdded(messagesRef, (snap) => {
      const data = snap.val();
      appendMessageDom(data);
    });

    // üîπ Show Message in DOM
    function appendMessageDom(data) {
      const div = document.createElement("div");
      div.className = "msg " + (data.senderId === userId ? "me" : "other");

      if (data.type === "text") {
        div.textContent = `${data.senderName}: ${data.text}`;
      } else if (data.type === "file") {
        div.textContent = `${data.senderName}: ${data.fileName}`;
        if ((data.mimeType || '').startsWith('image/')) {
          const img = document.createElement("img");
          img.src = data.fileData;
          img.className = "preview";
          div.appendChild(img);
        }
        if ((data.mimeType || '').startsWith('audio/')) {
          const audio = document.createElement("audio");
          audio.controls = true;
          audio.src = data.fileData;
          div.appendChild(audio);
        }
        if ((data.mimeType || '').startsWith('video/')) {
          const video = document.createElement("video");
          video.controls = true;
          video.width = 200;
          video.src = data.fileData;
          div.appendChild(video);
        }
        const btn = document.createElement("button");
        btn.textContent = "‚¨áÔ∏è Download";
        btn.onclick = () => {
          const a = document.createElement("a");
          a.href = data.fileData;
          a.download = data.fileName || "file";
          a.click();
        };
        div.appendChild(btn);
      }
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    // üîπ Show Online Users
    const usersRef = ref(db, "users");
    onValue(usersRef, (snap) => {
      usersEl.innerHTML = "<b>Users</b><br/>";
      const users = snap.val() || {};
      for (let uid in users) {
        const u = users[uid];
        const li = document.createElement("div");
        li.textContent = u.name + (u.online ? " ‚úÖ" : " ‚ùå");
        usersEl.appendChild(li);
      }
    });
  </script>
</head>
<body>
  <header>Firebase Realtime Chat</header>
  <div id="container">
    <div id="users"></div>
    <div id="chat">
      <div id="messages"></div>
      <div id="controls">
        <input id="msg" placeholder="Type message" />
        <input id="file" type="file" accept="audio/*,image/*,video/*" />
        <button id="sendFile">‚¨ÜÔ∏è</button>
        <button id="send">üì§</button>
      </div>
    </div>
  </div>
</body>
</html>
