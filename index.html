<!DOCTYPE html>
<html lang="hi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Customer Reward App</title>
    <style>
        /* बेसिक रीसेट और पेज की स्टाइलिंग */
        body {
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #e9ecef;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
        }

        /* ऐप के लिए मुख्य कंटेनर */
        .app-container {
            width: 100%;
            max-width: 450px;
            background-color: #ffffff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* 1. हेडर सेक्शन */
        .app-header {
            background-color: #a7f3d0;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: #1f2937;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .app-name { font-size: 1.5em; font-weight: bold; }
        .balance { background-color: #ffffff; padding: 8px 15px; border-radius: 20px; font-size: 1.1em; font-weight: 600; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05); }

        /* 2. मुख्य कंटेंट एरिया */
        .main-content { padding: 20px; flex-grow: 1; display: flex; flex-direction: column; }
        .coupon-section { position: relative; margin-bottom: 20px; }
        .coupon-input { width: 100%; padding: 15px 50px 15px 20px; font-size: 1em; border: 1px solid #d1d5db; border-radius: 30px; box-sizing: border-box; }
        .coupon-input::placeholder { color: #9ca3af; }
        .scanner-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; cursor: pointer; color: #ef4444; }
        
        /* रिडीम लिस्ट कंटेनर और आइटम स्टाइल */
        .list-header { text-align: center; font-size: 1.2em; font-weight: 500; color: #4b5563; padding: 10px; border-top: 1px solid #e5e7eb; border-bottom: 1px solid #e5e7eb; margin-top: 10px;}
        .redeem-list { flex-grow: 1; overflow-y: auto; padding-top: 10px; }
        .list-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 10px; background-color: #f9fafb; border-radius: 8px; margin-bottom: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .list-item-coupon { font-size: 0.9em; color: #374151; }
        .list-item-value { font-size: 1.1em; font-weight: 600; color: #16a34a; }

        /* QR स्कैनर पॉप-अप (Modal) के लिए CSS */
        #scanner-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0; top: 0;
            width: 100%; height: 100%;
            background-color: rgba(0,0,0,0.8);
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        #scanner-modal.active {
            display: flex;
        }
        #reader {
            width: 90%;
            max-width: 450px;
            background: black;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid white;
        }
        #close-scanner {
            position: absolute;
            top: 20px; right: 20px;
            color: white; background: #ef4444; border: none;
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.5em; font-weight: bold; cursor: pointer;
            line-height: 40px; text-align: center;
        }
        #scanner-status-text { color: white; margin-top: 15px; font-weight: 500; }

        /* अलर्ट संदेशों के लिए */
        .app-alert-container { position: sticky; top: 80px; z-index: 200; padding: 0 20px; }
        .app-alert { padding: 15px; color: white; text-align: center; font-weight: 500; border-radius: 8px; opacity: 0; transform: translateY(-20px); transition: opacity 0.3s ease, transform 0.3s ease; }
        .app-alert.show { opacity: 1; transform: translateY(0); }
        .app-alert.success { background-color: #22c55e; }
        .app-alert.error { background-color: #ef4444; }
    </style>
</head>
<body>

    <div class="app-container">
        <header class="app-header">
            <div class="app-name">Reward App</div>
            <div class="balance" id="balance-display">₹ 0</div>
        </header>
        <div class="app-alert-container" id="alert-box"></div>
        <main class="main-content">
            <div class="coupon-section">
                <input class="coupon-input" id="coupon-input" type="text" placeholder="कूपन कोड डालें या स्कैन करें">
                <div class="scanner-icon" id="scanner-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM3.75 9V7.5h-1.5V9h1.5zM3.75 13.5v-1.5h-1.5v1.5h1.5zM3.75 18v-1.5h-1.5V18h1.5zM8.25 4.5h-1.5v1.5h1.5V4.5zM8.25 9V7.5h-1.5V9h1.5zM8.25 13.5v-1.5h-1.5v1.5h1.5zM8.25 18v-1.5h-1.5V18h1.5zM12.75 4.5h-1.5v1.5h1.5V4.5zM12.75 9V7.5h-1.5V9h1.5zM12.75 13.5v-1.5h-1.5v1.5h1.5zM12.75 18v-1.5h-1.5V18h1.5zM17.25 4.5h-1.5v1.5h1.5V4.5zM17.25 9V7.5h-1.5V9h1.5zM17.25 13.5v-1.5h-1.5v1.5h1.5zM17.25 18v-1.5h-1.5V18h1.5zM21.75 4.5a.75.75 0 00-1.5 0v1.5h1.5V4.5zM21.75 9V7.5h-1.5V9h1.5zM21.75 13.5v-1.5h-1.5v1.5h1.5zM21.75 18v-1.5h-1.5V18h1.5z" /></svg>
                </div>
            </div>
            <div class="list-header">रिडीम लिस्ट</div>
            <div class="redeem-list" id="redeem-list"></div>
        </main>
    </div>

    <div id="scanner-modal">
        <button id="close-scanner">×</button>
        <div id="reader"></div>
        <div id="scanner-status-text">QR कोड को कैमरे के सामने लाएं</div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>

    <script>
    // 1. === कॉन्फ़िगरेशन ===
    const firebaseConfig = {
      apiKey: "AIzaSyBObxnvyUCZF1-qEy_kpw0YiQ8894igieA", // अपना apiKey यहाँ पेस्ट करें
      authDomain: "reward-card-aec2e.firebaseapp.com",
      databaseURL: "https://reward-card-aec2e-default-rtdb.firebaseio.com",
      projectId: "reward-card-aec2e",
      storageBucket: "reward-card-aec2e.appspot.com",
      messagingSenderId: "638220236646",
      appId: "1:638220236646:web:e0031855e948c26372d6f7"
    };
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // 2. === वेरिएबल्स और UI एलिमेंट्स ===
    const COUPON_VALUE = 10;
    const UI = {
        balance: document.getElementById('balance-display'),
        redeemList: document.getElementById('redeem-list'),
        couponInput: document.getElementById('coupon-input'),
        scannerButton: document.getElementById('scanner-button'),
        scannerModal: document.getElementById('scanner-modal'),
        closeScanner: document.getElementById('close-scanner'),
        alertBox: document.getElementById('alert-box'),
        scannerStatusText: document.getElementById('scanner-status-text'),
    };
    let currentUserId = null;
    let html5Qrcode = null;

    // 3. === उपयोगकर्ता और डेटा हैंडलिंग फ़ंक्शंस ===
    function handleUser() {
        currentUserId = localStorage.getItem('rewardAppUserId');
        if (!currentUserId) {
            currentUserId = database.ref().child('users').push().key;
            localStorage.setItem('rewardAppUserId', currentUserId);
        }
        loadUserData();
    }
    
    function loadUserData() {
        if (!currentUserId) return;
        const userRef = database.ref(`users/${currentUserId}`);
        userRef.child('balance').on('value', s => UI.balance.textContent = `₹ ${s.val()||0}`);
        userRef.child('redeemedCoupons').on('value', snapshot => {
            UI.redeemList.innerHTML = '';
            if (!snapshot.exists()) {
                UI.redeemList.innerHTML = '<p style="text-align:center;color:#6b7280;">कोई कूपन रिडीम नहीं हुआ है।</p>';
                return;
            }
            snapshot.forEach(child => {
                const coupon = child.val();
                const itemHTML = `<div class="list-item"><span class="list-item-coupon">${child.key}</span><span class="list-item-value">+ ₹${coupon.value}</span></div>`;
                UI.redeemList.insertAdjacentHTML('afterbegin', itemHTML);
            });
        });
    }

    function showAlert(message, isSuccess = true) {
        UI.alertBox.innerHTML = `<div class="app-alert ${isSuccess ? 'success' : 'error'}">${message}</div>`;
        const alertDiv = UI.alertBox.querySelector('.app-alert');
        setTimeout(() => alertDiv.classList.add('show'), 10);
        setTimeout(() => {
            alertDiv.classList.remove('show');
            alertDiv.addEventListener('transitionend', () => UI.alertBox.innerHTML = '');
        }, 4000);
    }

    async function redeemCoupon(rawCode) {
        if (!rawCode || rawCode.trim() === "") return;
        const couponId = rawCode.trim().toUpperCase();
        const couponRef = database.ref(`coupons/${couponId}`);

        couponRef.transaction(coupon => {
            if (!coupon) { showAlert("यह कूपन कोड अमान्य है।", false); return; }
            if (coupon.used) { showAlert(`कूपन ${couponId} पहले ही इस्तेमाल हो चुका है।`, false); return; }
            
            const isActivated = coupon.status === 'active' || (Date.now() - (coupon.activationTime || 0)) > 24*60*60*1000;
            if (!isActivated) { showAlert(`कूपन ${couponId} अभी सक्रिय नहीं है।`, false); return; }
            
            coupon.used = true;
            coupon.status = 'used';
            coupon.redeemedBy = currentUserId;
            coupon.redeemedAt = firebase.database.ServerValue.TIMESTAMP;
            return coupon;
        }, (error, committed) => {
            if (error) { showAlert("कुछ गलत हो गया, कृपया पुनः प्रयास करें।", false); } 
            else if (committed) {
                const userRef = database.ref(`users/${currentUserId}`);
                userRef.child('balance').transaction(balance => (balance || 0) + COUPON_VALUE);
                userRef.child(`redeemedCoupons/${couponId}`).set({ value: COUPON_VALUE, redeemedAt: firebase.database.ServerValue.TIMESTAMP });
                showAlert(`बधाई! कूपन ${couponId} सफलतापूर्वक रिडीम हो गया।`);
                UI.couponInput.value = '';
            }
        });
    }

    // 4. === पॉप-अप और स्कैनर लॉजिक ===
    function startScanner() {
        if (!html5Qrcode) html5Qrcode = new Html5Qrcode("reader");
        UI.scannerModal.classList.add('active');
        UI.scannerStatusText.textContent = "कैमरा शुरू हो रहा है...";

        html5Qrcode.start(
            { facingMode: "environment" },
            { fps: 10, qrbox: { width: 250, height: 250 } },
            onScanSuccess,
            (errorMessage) => {}
        ).then(() => {
            UI.scannerStatusText.textContent = "QR कोड को कैमरे के सामने लाएं";
        }).catch(err => {
            UI.scannerStatusText.textContent = "त्रुटि: कैमरा शुरू नहीं हो सका।";
            showAlert("कैमरा एक्सेस नहीं हो सका। कृपया अनुमति दें।", false);
            setTimeout(stopScanner, 1500);
        });
    }

    function stopScanner() {
        if (html5Qrcode && html5Qrcode.isScanning) {
            html5Qrcode.stop().catch(err => console.error("Scanner Stop Error:", err));
        }
        UI.scannerModal.classList.remove('active');
    }

    async function onScanSuccess(decodedText) {
        stopScanner();
        showAlert("QR कोड मिला, प्रोसेस हो रहा है...");
        let codeToRedeem = decodedText;
        try {
            const url = new URL(decodedText);
            const qrId = url.searchParams.get('qr');
            if(qrId) {
                const qrSnap = await database.ref(`qrCards/${qrId}`).once('value');
                if (qrSnap.exists() && qrSnap.val().coupon) codeToRedeem = qrSnap.val().coupon;
                else { showAlert("इस QR से जुड़ा कोई कूपन नहीं मिला।", false); return; }
            }
        } catch(e) {} // URL नहीं है, तो सीधे कोड का उपयोग करें
        await redeemCoupon(codeToRedeem);
    }
    
    // 5. === ऐप की शुरुआत और इवेंट्स ===
    window.onload = function() {
        handleUser();
        UI.scannerButton.addEventListener('click', startScanner);
        UI.closeScanner.addEventListener('click', stopScanner);
        UI.couponInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') redeemCoupon(UI.couponInput.value);
        });
    };
    </script>
</body>
</html>