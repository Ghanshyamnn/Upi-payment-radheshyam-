<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Google Login Demo</title>
</head>
<body>
  <h2>Google से लॉगिन करें</h2>
  <button onclick="loginWithGoogle()">Continue with Google</button>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
      authDomain: "grsc-chet.firebaseapp.com",
      databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
      projectId: "grsc-chet",
      storageBucket: "grsc-chet.appspot.com",
      messagingSenderId: "1029401721470",
      appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    // Random 6-character code
    function generateCode() {
      const chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let code = "";
      for (let i = 0; i < 6; i++) {
        code += chars.charAt(Math.floor(Math.random() * chars.length));
      }
      return code;
    }

    async function loginWithGoogle() {
      const provider = new firebase.auth.GoogleAuthProvider();
      try {
        const result = await auth.signInWithPopup(provider);
        const user = result.user;

        // Check if user has code in DB
        const userRef = db.ref("users/" + user.uid + "/code");
        const snapshot = await userRef.get();
        if (!snapshot.exists()) {
          let newCode = generateCode();
          // Save mapping
          await userRef.set(newCode);
          await db.ref("codes/" + newCode).set(user.uid);
        }
        alert("सफलतापूर्वक Google से लॉगिन हो गया: " + user.email);
      } catch (error) {
        alert("Error: " + error.message);
      }
    }

    // Auto login check
    auth.onAuthStateChanged(user => {
      if (user) {
        db.ref("users/" + user.uid + "/code").once("value")
          .then(snap => {
            alert("Welcome " + user.email + " (Code: " + snap.val() + ")");
          });
      }
    });
  </script>
</body>
</html>