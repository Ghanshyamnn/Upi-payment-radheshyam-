<!doctype html>
<html lang="hi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>üî• Gmail Login + Auto ID</title>
  <style>
    body{margin:0;font-family:sans-serif;background:#0f172a;color:#fff;display:flex;align-items:center;justify-content:center;height:100vh}
    .card{background:#111827;padding:20px;border-radius:16px;max-width:360px;width:100%;box-shadow:0 6px 20px rgba(0,0,0,.5);text-align:center}
    button{padding:12px 16px;border:none;border-radius:8px;font-weight:bold;cursor:pointer}
    .btn{background:#2563eb;color:#fff;width:100%}
    .hidden{display:none}
    img{border-radius:50%}
    .code{font-family:monospace;font-size:22px;margin:12px 0;padding:8px;background:#0b1220;border-radius:8px}
  </style>
</head>
<body>
  <div class="card">
    <h2>üîê Gmail Login</h2>
    <p id="msg">‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç</p>
    <button id="googleBtn" class="btn">Continue with Google</button>
    <div id="profile" class="hidden">
      <img id="avatar" width="60" height="60"/><br/>
      <h3 id="name"></h3>
      <p id="email"></p>
      <div class="code" id="userCode">------</div>
      <button id="logout" class="btn" style="background:#ef4444">Logout</button>
    </div>
  </div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyAa-r7rwMxNMZGKucXtwdHimKq77iX7MpM",
      authDomain: "grsc-chet.firebaseapp.com",
      databaseURL: "https://grsc-chet-default-rtdb.firebaseio.com",
      projectId: "grsc-chet",
      storageBucket: "grsc-chet.appspot.com",
      messagingSenderId: "1029401721470",
      appId: "1:1029401721470:web:c75cb33423c7f567ec362f"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db   = firebase.database();

    // UI Elements
    const googleBtn=document.getElementById('googleBtn');
    const profile=document.getElementById('profile');
    const nameEl=document.getElementById('name');
    const emailEl=document.getElementById('email');
    const avatar=document.getElementById('avatar');
    const codeEl=document.getElementById('userCode');
    const msg=document.getElementById('msg');
    const logoutBtn=document.getElementById('logout');

    function genCode(){
      const chars="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      let out=""; for(let i=0;i<6;i++) out+=chars[Math.floor(Math.random()*chars.length)];
      return out;
    }

    async function ensureUserCode(uid){
      const snap=await db.ref(`users/${uid}/code`).get();
      if(snap.exists()) return snap.val();
      for(let i=0;i<10;i++){
        const code=genCode();
        const res=await db.ref(`codes/${code}`).transaction(cur=>{if(cur===null)return uid;});
        if(res.committed && res.snapshot.val()===uid){
          await db.ref(`users/${uid}/code`).set(code);
          return code;
        }
      }
      throw new Error("Code ‡§¨‡§®‡§æ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ");
    }

    async function showProfile(user){
      const code=await ensureUserCode(user.uid);
      nameEl.textContent=user.displayName||"User";
      emailEl.textContent=user.email||"";
      avatar.src=user.photoURL||"";
      codeEl.textContent=code;
      profile.classList.remove("hidden");
      googleBtn.classList.add("hidden");
      msg.textContent="‡§∏‡§´‡§≤‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§µ‡§ï ‡§≤‡•â‡§ó‡§ø‡§® ‡§π‡•ã ‡§ó‡§Ø‡§æ ‚úÖ";
    }

    function hideProfile(){
      profile.classList.add("hidden");
      googleBtn.classList.remove("hidden");
      msg.textContent="‡§≤‡•â‡§ó‡§ø‡§® ‡§ï‡§∞‡§®‡•á ‡§ï‡•á ‡§≤‡§ø‡§è ‡§®‡•Ä‡§ö‡•á ‡§ï‡•ç‡§≤‡§ø‡§ï ‡§ï‡§∞‡•á‡§Ç";
    }

    // Auth flow
    const provider=new firebase.auth.GoogleAuthProvider();
    googleBtn.onclick=async()=>{
      try{
        const isMobile=/Android|iPhone|iPad|iPod/i.test(navigator.userAgent);
        if(isMobile) await auth.signInWithRedirect(provider);
        else await auth.signInWithPopup(provider);
      }catch(e){alert("Error: "+e.message);}
    };
    logoutBtn.onclick=()=>auth.signOut();

    auth.getRedirectResult().catch(e=>alert(e.message));
    auth.onAuthStateChanged(user=>{
      if(user) showProfile(user);
      else hideProfile();
    });
  </script>
</body>
</html>