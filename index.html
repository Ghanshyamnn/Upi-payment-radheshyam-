<!DOCTYPE html>
<html lang="hi">
<head>
  <meta charset="UTF-8" />
  <title>üì∑ Photo Share Gallery</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <style>
    body{font-family:sans-serif;margin:0;padding:0;background:#f4f4f4;}
    header{background:#2196f3;color:#fff;padding:12px;text-align:center;font-size:20px;}
    .online{margin:10px;color:#333;text-align:center;}
    .gallery{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:15px;padding:20px;}
    .card{background:#fff;border-radius:12px;box-shadow:0 0 6px rgba(0,0,0,0.2);padding:10px;text-align:center;}
    .card img{max-width:100%;border-radius:8px;cursor:pointer;transition:0.3s;}
    .card img:hover{transform:scale(1.05);}
    button{margin:6px 4px;padding:6px 10px;background:#2196f3;color:#fff;border:none;border-radius:6px;font-size:14px;cursor:pointer;}
    button.delete{background:#e53935;}
    hr{margin:20px 0;}
    .admin{text-align:center;padding:15px;background:#fff;}
    /* Lightbox */
    #lightbox{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.8);justify-content:center;align-items:center;z-index:999;}
    #lightbox img{max-width:90%;max-height:90%;border-radius:12px;box-shadow:0 0 12px #000;}
  </style>
</head>
<body>
  <header>üì∑ Photo Share Gallery</header>
  <div id="online" class="online"></div>

  <div id="gallery" class="gallery"></div>

  <hr>
  <!-- Admin Section -->
  <div class="admin">
    <h3>üì§ Admin Upload</h3>
    <input type="file" id="fileInput" accept="image/*" />
    <button onclick="uploadPhoto()">Upload</button>
  </div>

  <!-- Lightbox -->
  <div id="lightbox" onclick="closeLightbox()">
    <img id="lightboxImg" src="" alt="Preview" />
  </div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD14Z3b7uCk62FBCK9SSZlczSxnMXndM1o",
      authDomain: "mp3-8247a.firebaseapp.com",
      databaseURL: "https://mp3-8247a-default-rtdb.firebaseio.com",
      projectId: "mp3-8247a",
      storageBucket: "mp3-8247a.firebasestorage.app",
      messagingSenderId: "228735051694",
      appId: "1:228735051694:web:99bdbbe737b66224ef4a3f"
    };
    firebase.initializeApp(firebaseConfig);
    const db=firebase.database();

    const gallery=document.getElementById("gallery");
    const online=document.getElementById("online");
    const lightbox=document.getElementById("lightbox");
    const lightboxImg=document.getElementById("lightboxImg");

    // Unique userId
    let userId=localStorage.getItem("userId");
    if(!userId){
      userId="user_"+Math.random().toString(36).substr(2,9);
      localStorage.setItem("userId",userId);
    }

    // Presence
    const userRef=db.ref("onlineUsers/"+userId);
    userRef.set(true); userRef.onDisconnect().remove();
    db.ref("onlineUsers").on("value",snap=>{
      online.textContent="Online Users: "+(snap.numChildren()||0);
    });

    // Load all images realtime
    db.ref("images").on("value",async snap=>{
      gallery.innerHTML="";
      const data=snap.val()||{};
      const keys=Object.keys(data);
      for(const key of keys){
        await loadPhotoCard(key,data[key]);
      }
    });

    async function loadPhotoCard(key,val){
      if(!val || !val.chunks){ return; }
      const chunks=val.chunks;
      const keys=Object.keys(chunks).sort((a,b)=>+a-+b);
      let base64="";
      for(let i=0;i<keys.length;i++){
        base64+=chunks[keys[i]];
        if(i%5===0){ await new Promise(r=>setTimeout(r,5)); }
      }
      const dataUrl=`data:${val.mime||"image/png"};base64,${base64}`;

      const card=document.createElement("div");
      card.className="card";
      card.innerHTML=`
        <div>${val.name}</div>
        <img src="${dataUrl}" alt="photo" onclick="openLightbox('${dataUrl}')"/>
        <div>
          <button onclick="downloadPhoto('${val.name}','${dataUrl}')">Download</button>
          <button class="delete" onclick="deletePhoto('${key}')">Delete</button>
        </div>
      `;
      gallery.appendChild(card);
    }

    function downloadPhoto(name,url){
      const a=document.createElement("a");
      a.href=url;
      a.download=name || "photo.png";
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }

    function deletePhoto(key){
      if(confirm("‡§ï‡•ç‡§Ø‡§æ ‡§Ü‡§™ ‡§Ø‡§π ‡§´‡•ã‡§ü‡•ã ‡§°‡§ø‡§≤‡•Ä‡§ü ‡§ï‡§∞‡§®‡§æ ‡§ö‡§æ‡§π‡§§‡•á ‡§π‡•à‡§Ç?")){
        db.ref("images/"+key).remove();
        alert("üóë ‡§´‡•ã‡§ü‡•ã delete ‡§π‡•ã ‡§ó‡§à");
      }
    }

    // Lightbox
    function openLightbox(url){
      lightbox.style.display="flex";
      lightboxImg.src=url;
    }
    function closeLightbox(){
      lightbox.style.display="none";
      lightboxImg.src="";
    }

    // ================= ADMIN UPLOAD =================
    async function uploadPhoto(){
      const file=document.getElementById("fileInput").files[0];
      if(!file){ alert("‡§™‡§π‡§≤‡•á ‡§´‡•ã‡§ü‡•ã ‡§ö‡•Å‡§®‡•á‡§Ç"); return; }
      const reader=new FileReader();
      reader.onload=function(e){
        const dataUrl=e.target.result;
        const base64=dataUrl.split(",")[1];
        const chunkSize=50000; // 50KB
        const chunks={};
        for(let i=0;i<base64.length;i+=chunkSize){
          chunks[i/chunkSize]=base64.substring(i,i+chunkSize);
        }
        const key="img_"+Date.now();
        db.ref("images/"+key).set({
          name:file.name,
          mime:file.type,
          chunks:chunks
        });
        alert("‚úÖ ‡§´‡•ã‡§ü‡•ã upload ‡§π‡•ã ‡§ó‡§à");
      };
      reader.readAsDataURL(file);
    }
  </script>
</body>
</html>
